<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Digital Holdings - Professional Trading Platform</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- TradingView Widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --dark-color: #34495e;
            --light-color: #ecf0f1;
            --buy-color: #00c853;
            --sell-color: #ff4444;
            --profit-color: #00c853;
            --loss-color: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: white;
            min-height: 100vh;
            box-shadow: 3px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            width: 250px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar.collapsed .nav-link span,
        .sidebar.collapsed .brand-text,
        .sidebar.collapsed .quick-stats {
            display: none;
        }

        .sidebar.collapsed .nav-link {
            text-align: center;
            padding: 12px 5px;
        }

        .sidebar.collapsed .nav-link i {
            margin-right: 0;
        }

        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 5px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }

        .sidebar .nav-link i {
            width: 20px;
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .brand-container {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 10px;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .brand-text {
            margin-left: 10px;
        }

        .toggle-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 20px;
        }

        /* Quick Stats in Sidebar */
        .quick-stats {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            text-align: center;
        }

        .quick-stats small {
            color: rgba(255,255,255,0.7);
            display: block;
            margin-bottom: 5px;
        }

        .quick-stats .fw-bold {
            font-size: 1.1rem;
        }

        /* Main Content Area */
        .main-content {
            margin-left: 250px;
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        .main-content.expanded {
            margin-left: 70px;
        }

        /* Navigation Bar */
        .top-navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px 20px;
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .nav-user-info {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }

        /* Notification Styles */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-item {
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .notification-item.unread {
            background-color: #e3f2fd;
            border-left-color: var(--accent-color);
        }

        .notification-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Card Styles */
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .stat-card .card-title {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-card .card-change {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .bg-wallet { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
        }
        .bg-deposit { 
            background: linear-gradient(45deg, #f093fb, #f5576c); 
            color: white; 
        }
        .bg-investment { 
            background: linear-gradient(45deg, #4facfe, #00f2fe); 
            color: white; 
        }
        .bg-profit { 
            background: linear-gradient(45deg, #43e97b, #38f9d7); 
            color: white; 
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .table-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: none;
            overflow: hidden;
        }

        .table-card .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 15px 20px;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            color: var(--primary-color);
            background-color: #f8f9fa;
            padding: 15px;
        }

        .table td {
            padding: 15px;
            vertical-align: middle;
        }

        /* Badge Styles */
        .badge-success { 
            background-color: var(--success-color); 
            color: white;
        }
        .badge-warning { 
            background-color: var(--warning-color); 
            color: white;
        }
        .badge-danger { 
            background-color: var(--accent-color); 
            color: white;
        }
        .badge-info { 
            background-color: var(--info-color); 
            color: white;
        }
        .badge-primary { 
            background-color: var(--secondary-color); 
            color: white;
        }

        /* Button Styles */
        .btn-primary {
            background: linear-gradient(45deg, var(--secondary-color), #2980b9);
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success-color), #219a52);
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, var(--warning-color), #e67e22);
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--accent-color), #c0392b);
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-outline-primary {
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
            background: transparent;
            border-radius: 8px;
            padding: 8px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            background: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
        }

        /* Modal Styles */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-header {
            border-bottom: 1px solid #e9ecef;
            padding: 20px 25px;
        }

        .modal-footer {
            border-top: 1px solid #e9ecef;
            padding: 20px 25px;
        }

        /* Investment Plan Styles */
        .investment-plan {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .investment-plan:hover {
            border-color: var(--secondary-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .investment-plan.selected {
            border-color: var(--secondary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }

        .plan-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .plan-rate {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--success-color);
            margin: 15px 0;
        }

        .plan-features {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .plan-features li {
            padding: 5px 0;
            color: #6c757d;
        }

        /* Trading Room Styles */
        .trading-room {
            background: #1e1e1e;
            color: white;
            min-height: calc(100vh - 80px);
        }

        .trading-header {
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            padding: 15px 20px;
        }

        .trading-chart {
            height: 500px;
            background: #131722;
            border: 1px solid #2a2e39;
        }

        .trading-panel {
            background: #2d2d2d;
            border-left: 1px solid #404040;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .order-form {
            background: #2d2d2d;
            padding: 20px;
            border-bottom: 1px solid #404040;
        }

        .market-data {
            background: #2d2d2d;
            padding: 15px;
        }

        .position-item {
            background: #363636;
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid var(--success-color);
            transition: all 0.3s ease;
        }

        .position-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .position-item.sell {
            border-left-color: var(--sell-color);
        }

        .order-book {
            background: #2d2d2d;
            padding: 15px;
        }

        .bid-row {
            background: rgba(0, 200, 83, 0.1);
            padding: 5px 10px;
            margin: 2px 0;
            border-radius: 3px;
        }

        .ask-row {
            background: rgba(255, 68, 68, 0.1);
            padding: 5px 10px;
            margin: 2px 0;
            border-radius: 3px;
        }

        .btn-buy {
            background: var(--buy-color);
            border: none;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-buy:hover {
            background: #00b34a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 200, 83, 0.4);
        }

        .btn-sell {
            background: var(--sell-color);
            border: none;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-sell:hover {
            background: #e63c3c;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 68, 68, 0.4);
        }

        .trading-tabs .nav-link {
            color: #ccc;
            border: none;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }

        .trading-tabs .nav-link.active {
            background: #363636;
            color: white;
            border-bottom: 2px solid var(--secondary-color);
        }

        .instrument-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .instrument-item {
            padding: 10px;
            border-bottom: 1px solid #404040;
            cursor: pointer;
            transition: background 0.3s;
        }

        .instrument-item:hover {
            background: #363636;
        }

        .instrument-item.active {
            background: var(--secondary-color);
        }

        .price-up {
            color: var(--buy-color);
        }

        .price-down {
            color: var(--sell-color);
        }

        .indicator-settings {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .timeframe-selector {
            display: flex;
            gap: 5px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .timeframe-btn {
            padding: 5px 10px;
            border: 1px solid #404040;
            background: #2d2d2d;
            color: #ccc;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timeframe-btn.active {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .timeframe-btn:hover:not(.active) {
            background: #363636;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* WebSocket Status */
        .websocket-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .websocket-connected {
            background-color: var(--success-color);
            color: white;
        }

        .websocket-disconnected {
            background-color: var(--accent-color);
            color: white;
        }

        /* Trading specific styles */
        .leverage-slider {
            width: 100%;
            margin: 10px 0;
        }

        .risk-indicator {
            height: 5px;
            background: #404040;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .risk-level {
            height: 100%;
            background: var(--success-color);
            transition: width 0.3s;
        }

        .trading-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }

        .toast {
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar .nav-link span,
            .sidebar .brand-text,
            .sidebar .quick-stats {
                display: none;
            }
            
            .sidebar .nav-link {
                text-align: center;
                padding: 12px 5px;
            }
            
            .sidebar .nav-link i {
                margin-right: 0;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .stat-card .card-value {
                font-size: 1.5rem;
            }
            
            .trading-panel {
                height: auto;
                border-left: none;
                border-top: 1px solid #404040;
            }
        }

        @media (max-width: 576px) {
            .timeframe-selector {
                justify-content: center;
            }
            
            .btn-buy, .btn-sell {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .investment-plan {
                padding: 15px;
            }
            
            .plan-rate {
                font-size: 2rem;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }

        .trading-panel::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .trading-panel::-webkit-scrollbar-thumb {
            background: #555;
        }

        .trading-panel::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Utility Classes */
        .text-profit {
            color: var(--profit-color);
        }

        .text-loss {
            color: var(--loss-color);
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .border-radius-10 {
            border-radius: 10px;
        }

        .shadow-custom {
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .hover-lift:hover {
            transform: translateY(-3px);
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="brand-container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-globe-americas"></i>
                <span class="brand-text">WCTRADE</span>
            </a>
            <button class="toggle-sidebar" id="toggleSidebar">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="trading">
                    <i class="fas fa-chart-bar"></i>
                    <span>Trading Room</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="deposit">
                    <i class="fas fa-wallet"></i>
                    <span>Deposit Funds</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="invest">
                    <i class="fas fa-chart-line"></i>
                    <span>Invest</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="transactions">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Transactions</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="earnings">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Earnings</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="reports">
                    <i class="fas fa-file-alt"></i>
                    <span>Reports</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
        </ul>

        <div class="quick-stats">
            <small class="text-white-50">QUICK STATS</small>
            <div class="row mt-2 text-white">
                <div class="col-6">
                    <small>This Week</small>
                    <div class="fw-bold" id="quickWeekEarnings">$0</div>
                </div>
                <div class="col-6">
                    <small>Referrals</small>
                    <div class="fw-bold" id="quickReferrals">0</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Navigation Bar -->
        <nav class="top-navbar">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div>
                        <h4 class="mb-0" id="pageTitle">Dashboard</h4>
                    </div>
                    
                    <div class="d-flex align-items-center">
                        <!-- Notifications -->
                        <div class="dropdown me-3">
                            <a href="#" class="text-dark position-relative" id="notificationDropdown" data-bs-toggle="dropdown">
                                <i class="fas fa-bell fa-lg"></i>
                                <span class="notification-badge" id="notificationCount">0</span>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end p-3" style="width: 350px;">
                                <h6 class="dropdown-header">Notifications</h6>
                                <div id="notificationList">
                                    <!-- Notifications will be loaded here -->
                                </div>
                                <div class="text-center mt-2">
                                    <a href="#" class="text-decoration-none" onclick="loadNotifications()">View All</a>
                                </div>
                            </div>
                        </div>

                        <!-- User Menu -->
                        <div class="dropdown">
                            <a href="#" class="text-dark text-decoration-none dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown">
                                <div class="user-avatar" id="userAvatar">JD</div>
                                <span id="userName">Loading...</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="showProfileModal()"><i class="fas fa-user me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showReferralsModal()"><i class="fas fa-users me-2"></i>Referrals</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="container-fluid py-4">
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card bg-wallet text-white">
                        <i class="fas fa-wallet"></i>
                        <div class="card-title">Wallet Balance</div>
                        <div class="card-value" id="walletBalance">$0.00</div>
                        <div class="card-change">
                            <i class="fas fa-arrow-up me-1"></i>
                            <span id="walletChange">0%</span> from last week
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card bg-deposit text-white">
                        <i class="fas fa-piggy-bank"></i>
                        <div class="card-title">Deposit Balance</div>
                        <div class="card-value" id="depositBalance">$0.00</div>
                        <div class="card-change">
                            <i class="fas fa-arrow-up me-1"></i>
                            <span id="depositChange">0%</span> available for investment
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card bg-investment text-white">
                        <i class="fas fa-chart-line"></i>
                        <div class="card-title">Total Invested</div>
                        <div class="card-value" id="totalInvested">$0.00</div>
                        <div class="card-change">
                            <i class="fas fa-arrow-up me-1"></i>
                            <span id="investmentChange">0%</span> active investments
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card bg-profit text-white">
                        <i class="fas fa-money-bill-wave"></i>
                        <div class="card-title">Total Profit</div>
                        <div class="card-value" id="totalProfit">$0.00</div>
                        <div class="card-change">
                            <i class="fas fa-arrow-up me-1"></i>
                            <span id="profitChange">0%</span> this month
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Recent Activity -->
            <div class="row">
                <!-- Earnings Chart -->
                <div class="col-lg-8 mb-4">
                    <div class="chart-container">
                        <h5 class="mb-4">Earnings Overview</h5>
                        <canvas id="earningsChart" height="250"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="col-lg-4 mb-4">
                    <div class="chart-container">
                        <h5 class="mb-4">Recent Activity</h5>
                        <div id="recentActivity">
                            <!-- Activity items will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container">
                        <h5 class="mb-4">Quick Actions</h5>
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-primary w-100 py-3" onclick="showSection('deposit')">
                                    <i class="fas fa-plus-circle fa-2x mb-2"></i><br>
                                    Deposit Funds
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-success w-100 py-3" onclick="showSection('invest')">
                                    <i class="fas fa-chart-line fa-2x mb-2"></i><br>
                                    New Investment
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-info w-100 py-3" onclick="showSection('transactions')">
                                    <i class="fas fa-history fa-2x mb-2"></i><br>
                                    View Transactions
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-warning w-100 py-3" onclick="showReferralsModal()">
                                    <i class="fas fa-users fa-2x mb-2"></i><br>
                                    Refer Friends
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Investments -->
            <div class="row">
                <div class="col-12">
                    <div class="table-card">
                        <div class="card-header bg-transparent">
                            <h5 class="mb-0">Active Investments</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Plan</th>
                                            <th>Amount</th>
                                            <th>Profit Rate</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="investmentsTable">
                                        <!-- Investments will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Room Section -->
        <div id="tradingSection" style="display: none;">
            <div class="trading-room">
                <!-- Trading Header -->
                <div class="trading-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h4 class="mb-0 me-4">Trading Room</h4>
                        <div class="timeframe-selector">
                            <button class="timeframe-btn active" data-timeframe="1">1m</button>
                            <button class="timeframe-btn" data-timeframe="5">5m</button>
                            <button class="timeframe-btn" data-timeframe="15">15m</button>
                            <button class="timeframe-btn" data-timeframe="30">30m</button>
                            <button class="timeframe-btn" data-timeframe="60">1h</button>
                            <button class="timeframe-btn" data-timeframe="240">4h</button>
                            <button class="timeframe-btn" data-timeframe="D">1D</button>
                            <button class="timeframe-btn" data-timeframe="W">1W</button>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <span class="text-muted">Balance: </span>
                            <span class="fw-bold text-success" id="tradingBalance">$0.00</span>
                        </div>
                        <div class="me-3">
                            <span class="text-muted">Free Margin: </span>
                            <span class="fw-bold text-info" id="freeMargin">$0.00</span>
                        </div>
                        <button class="btn btn-sm btn-outline-light" onclick="showTradingSettings()">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>

                <div class="row g-0">
                    <!-- Left Panel - Chart -->
                    <div class="col-lg-8 col-xl-9">
                        <!-- Chart Container -->
                        <div class="trading-chart" id="tradingChart"></div>
                        
                        <!-- Trading Tools -->
                        <div class="bg-dark p-3 border-top border-secondary">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-light mb-3">Technical Indicators</h6>
                                    <div class="row g-2">
                                        <div class="col-4">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="addIndicator('MACD')">MACD</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="addIndicator('RSI')">RSI</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="addIndicator('BB')">Bollinger</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="addIndicator('SMA')">SMA</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="addIndicator('EMA')">EMA</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="addIndicator('Stoch')">Stochastic</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-light mb-3">Drawing Tools</h6>
                                    <div class="row g-2">
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('line')" title="Line">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('ray')" title="Ray">
                                                <i class="fas fa-long-arrow-alt-right"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('horizontal')" title="Horizontal Line">
                                                <i class="fas fa-arrows-alt-h"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('vertical')" title="Vertical Line">
                                                <i class="fas fa-arrows-alt-v"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('rectangle')" title="Rectangle">
                                                <i class="fas fa-square"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('circle')" title="Circle">
                                                <i class="fas fa-circle"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('fibonacci')" title="Fibonacci">
                                                <i class="fas fa-wave-square"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-danger w-100" onclick="clearDrawings()" title="Clear All">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - Trading Tools -->
                    <div class="col-lg-4 col-xl-3 trading-panel">
                        <!-- Instrument Selection -->
                        <div class="market-data">
                            <h6 class="text-light mb-3">Markets</h6>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control bg-dark text-light border-secondary" 
                                       placeholder="Search instruments..." id="instrumentSearch">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="instrument-list">
                                <!-- Instruments will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Order Form -->
                        <div class="order-form">
                            <h6 class="text-light mb-3">Quick Trade</h6>
                            <div class="mb-3">
                                <label class="form-label text-light">Instrument</label>
                                <select class="form-select bg-dark text-light border-secondary" id="tradeSymbol">
                                    <option value="BTCUSD">BTC/USD</option>
                                    <option value="ETHUSD">ETH/USD</option>
                                    <option value="XRPUSD">XRP/USD</option>
                                    <option value="LTCUSD">LTC/USD</option>
                                    <option value="ADAUSD">ADA/USD</option>
                                </select>
                            </div>
                            
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="form-label text-light">Lots</label>
                                    <input type="number" class="form-control bg-dark text-light border-secondary" 
                                           id="tradeVolume" value="0.01" min="0.01" step="0.01">
                                </div>
                                <div class="col-6">
                                    <label class="form-label text-light">Leverage</label>
                                    <select class="form-select bg-dark text-light border-secondary" id="tradeLeverage">
                                        <option value="1">1:1</option>
                                        <option value="5">1:5</option>
                                        <option value="10">1:10</option>
                                        <option value="25">1:25</option>
                                        <option value="50">1:50</option>
                                        <option value="100">1:100</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-light">Take Profit</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" 
                                       id="takeProfit" placeholder="Auto calculate">
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-light">Stop Loss</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" 
                                       id="stopLoss" placeholder="Auto calculate">
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-light">Risk Management</label>
                                <div class="risk-indicator">
                                    <div class="risk-level" id="riskLevel" style="width: 30%;"></div>
                                </div>
                                <small class="text-muted" id="riskPercentage">30% of balance at risk</small>
                            </div>

                            <div class="row g-2">
                                <div class="col-6">
                                    <button class="btn btn-buy w-100 py-3" onclick="placeOrder('buy')">
                                        <i class="fas fa-arrow-up me-2"></i>BUY
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-sell w-100 py-3" onclick="placeOrder('sell')">
                                        <i class="fas fa-arrow-down me-2"></i>SELL
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Positions -->
                        <div class="market-data">
                            <h6 class="text-light mb-3">Open Positions</h6>
                            <div id="openPositions">
                                <!-- Positions will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Order Book -->
                        <div class="order-book">
                            <h6 class="text-light mb-3">Order Book</h6>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between text-light">
                                    <span>Price</span>
                                    <span>Size</span>
                                </div>
                            </div>
                            <div id="orderBookBids">
                                <!-- Bids will be populated by JavaScript -->
                            </div>
                            <div class="text-center my-2">
                                <span class="text-warning fw-bold" id="currentPrice">$0.00</span>
                            </div>
                            <div id="orderBookAsks">
                                <!-- Asks will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Other Sections (Deposit, Invest, Transactions, etc.) -->
        <div id="otherSections" style="display: none;"></div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading...</p>
        </div>
    </div>

    <!-- Trading Alerts -->
    <div class="trading-alert" id="tradingAlert" style="display: none;"></div>

    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Trading Settings Modal -->
    <div class="modal fade" id="tradingSettingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Trading Settings</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Risk Management</h6>
                            <div class="mb-3">
                                <label class="form-label">Max Risk Per Trade (%)</label>
                                <input type="range" class="form-range" id="maxRisk" min="1" max="100" value="5">
                                <div class="d-flex justify-content-between">
                                    <small>1%</small>
                                    <small id="maxRiskValue">5%</small>
                                    <small>100%</small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Daily Loss Limit ($)</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" 
                                       id="dailyLossLimit" value="1000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Trading Preferences</h6>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="soundAlerts" checked>
                                    <label class="form-check-label" for="soundAlerts">
                                        Sound Alerts
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="confirmOrders" checked>
                                    <label class="form-check-label" for="confirmOrders">
                                        Confirm Orders
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="oneClickTrading">
                                    <label class="form-check-label" for="oneClickTrading">
                                        One-Click Trading
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTradingSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal fade" id="depositModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Deposit Funds</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="depositForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Amount (USD)</label>
                                <input type="number" class="form-control" name="amount" required min="10">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Payment Method</label>
                                <select class="form-select" name="paymentMethod" required>
                                    <option value="bitcoin">Bitcoin</option>
                                    <option value="tether">USDT (TRC20)</option>
                                    <option value="bank">Bank Transfer</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Wallet Address</label>
                            <input type="text" class="form-control" name="walletAddress" required placeholder="Enter your wallet address">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Proof of Payment</label>
                            <input type="file" class="form-control" name="proof" accept="image/*,.pdf" required>
                            <small class="text-muted">Upload screenshot or PDF of transaction</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitDeposit()">Submit Deposit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Investment Modal -->
    <div class="modal fade" id="investmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Make Investment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="investmentForm">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="investment-plan" data-plan="1" onclick="selectPlan(1)">
                                    <div class="plan-name">Basic Plan</div>
                                    <div class="plan-rate">5%</div>
                                    <div class="text-muted">30 days</div>
                                    <small>$50 - $1,000</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="investment-plan" data-plan="2" onclick="selectPlan(2)">
                                    <div class="plan-name">Premium Plan</div>
                                    <div class="plan-rate">8%</div>
                                    <div class="text-muted">30 days</div>
                                    <small>$1,001 - $5,000</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="investment-plan" data-plan="3" onclick="selectPlan(3)">
                                    <div class="plan-name">VIP Plan</div>
                                    <div class="plan-rate">12%</div>
                                    <div class="text-muted">30 days</div>
                                    <small>$5,001 - $20,000</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Investment Amount</label>
                                <input type="number" class="form-control" name="amount" required id="investmentAmount">
                                <small class="text-muted">Available deposit: $<span id="availableDeposit">0</span></small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Selected Plan</label>
                                <input type="text" class="form-control" id="selectedPlanName" readonly>
                                <input type="hidden" name="planId" id="selectedPlanId">
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <strong>Expected Profit:</strong> $<span id="expectedProfit">0</span> 
                            (<span id="profitRate">0</span>% return)
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="submitInvestment()" id="investButton" disabled>
                        Confirm Investment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Profile Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="profileForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control" name="name" id="profileName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" value="" id="profileEmail" readonly>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Bitcoin Wallet</label>
                                <input type="text" class="form-control" name="bitcoinAccount" id="profileBitcoin">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">USDT (TRC20) Wallet</label>
                                <input type="text" class="form-control" name="tetherTRC20Account" id="profileTether">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Security Question</label>
                                <input type="text" class="form-control" name="secretQuestion" id="profileQuestion" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Security Answer</label>
                                <input type="password" class="form-control" name="secretAnswer" id="profileAnswer" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateProfile()">Update Profile</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Referrals Modal -->
    <div class="modal fade" id="referralsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Referral Program</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 id="totalReferrals">0</h3>
                                    <p class="text-muted">Total Referrals</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6>Your Referral Code</h6>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="referralCode" readonly>
                                        <button class="btn btn-outline-primary" onclick="copyReferralCode()">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Referral Link</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="referralLink" readonly>
                            <button class="btn btn-outline-primary" onclick="copyReferralLink()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Joined</th>
                                    <th>Invested</th>
                                </tr>
                            </thead>
                            <tbody id="referralsList">
                                <!-- Referrals will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WebSocket Status -->
    <div class="websocket-status" id="websocketStatus">
        <i class="fas fa-wifi me-1"></i>
        <span>Connecting...</span>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script> 

// Global variables
let currentUser = null;
let websocket = null;
let earningsChart = null;
let selectedPlan = null;
let tradingChart = null;
let currentInstrument = 'BTCUSD';
let currentTimeframe = '1';
let openPositions = [];
let orderBook = { bids: [], asks: [] };
let tradingSettings = {
    maxRisk: 5,
    dailyLossLimit: 1000,
    soundAlerts: true,
    confirmOrders: true,
    oneClickTrading: false
};

// API Configuration
const API_BASE_URL = 'http://localhost:4000/api'; // Change to your backend URL when deployed

// Initialize dashboard when page loads
$(document).ready(function() {
    checkAuthentication();
    initializeWebSocket();
    loadDashboardData();
    setupEventListeners();
    initializeTradingRoom();
});

// Authentication check
function checkAuthentication() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'login.html';
        return;
    }
    
    // Fetch user data from backend
    fetchUserData();
}

// Fetch user data from backend
async function fetchUserData() {
    try {
        const response = await fetch(`${API_BASE_URL}/me`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to fetch user data');
        }

        const result = await response.json();
        
        if (result.success) {
            currentUser = result.data.user;
            updateUserInterface();
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error fetching user data:', error);
        // Fallback to mock data for demo
        currentUser = {
            _id: '1',
            name: 'John Doe',
            email: 'john.doe@example.com',
            walletBalance: 12500.75,
            depositBalance: 8500.00,
            totalInvested: 7200.00,
            totalProfit: 3250.50,
            referralCode: 'GALAXY123',
            bitcoinAccount: '',
            tetherTRC20Account: '',
            secretQuestion: 'What is your mother\'s maiden name?',
            secretAnswer: ''
        };
        updateUserInterface();
    }
}

// Update user interface with user data
function updateUserInterface() {
    if (!currentUser) return;
    
    $('#userName').text(currentUser.name);
    $('#userAvatar').text(currentUser.name.split(' ').map(n => n[0]).join(''));
    $('#walletBalance').text('$' + currentUser.walletBalance.toLocaleString());
    $('#depositBalance').text('$' + currentUser.depositBalance.toLocaleString());
    $('#totalInvested').text('$' + currentUser.totalInvested.toLocaleString());
    $('#totalProfit').text('$' + currentUser.totalProfit.toLocaleString());
    $('#tradingBalance').text('$' + currentUser.walletBalance.toLocaleString());
    $('#freeMargin').text('$' + (currentUser.walletBalance * 0.8).toLocaleString());
    $('#availableDeposit').text(currentUser.depositBalance.toLocaleString());
    $('#referralCode').val(currentUser.referralCode);
    $('#referralLink').val(`${window.location.origin}/register?ref=${currentUser.referralCode}`);
    
    // Profile form
    $('#profileName').val(currentUser.name);
    $('#profileEmail').val(currentUser.email);
    $('#profileBitcoin').val(currentUser.bitcoinAccount || '');
    $('#profileTether').val(currentUser.tetherTRC20Account || '');
    $('#profileQuestion').val(currentUser.secretQuestion || '');
}

// Initialize WebSocket connection
function initializeWebSocket() {
    try {
        // For demo purposes, we'll simulate WebSocket behavior
        simulateWebSocketConnection();
        
        // WebSocket event handlers
        websocket.onopen = function() {
            updateWebSocketStatus(true);
            console.log('WebSocket connected');
        };
        
        websocket.onclose = function() {
            updateWebSocketStatus(false);
            console.log('WebSocket disconnected');
            // Attempt to reconnect after 5 seconds
            setTimeout(initializeWebSocket, 5000);
        };
        
        websocket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            handleWebSocketMessage(data);
        };
        
        websocket.onerror = function(error) {
            console.error('WebSocket error:', error);
            updateWebSocketStatus(false);
        };
        
    } catch (error) {
        console.error('WebSocket initialization failed:', error);
        updateWebSocketStatus(false);
    }
}

// Simulate WebSocket for demo
function simulateWebSocketConnection() {
    websocket = {
        connected: true,
        onopen: null,
        onclose: null,
        onmessage: null,
        onerror: null,
        send: function(data) {
            console.log('WebSocket send:', data);
            // Simulate response
            setTimeout(() => {
                if (this.onmessage) {
                    const parsedData = JSON.parse(data);
                    const response = this.simulateResponse(parsedData);
                    this.onmessage({ data: JSON.stringify(response) });
                }
            }, 100);
        },
        close: function() {
            this.connected = false;
            if (this.onclose) this.onclose();
        },
        simulateResponse: function(data) {
            // Simulate various responses based on the request
            if (data.type === 'subscribe' && data.channel === 'prices') {
                return {
                    type: 'price_update',
                    symbol: data.symbol,
                    price: (Math.random() * 1000 + 40000).toFixed(2),
                    change: (Math.random() - 0.5) * 10
                };
            }
            return { type: 'ack', success: true };
        }
    };
    
    // Simulate connection opening
    setTimeout(() => {
        if (websocket.onopen) websocket.onopen();
    }, 1000);
}

// Update WebSocket status indicator
function updateWebSocketStatus(connected) {
    const statusElement = $('#websocketStatus');
    if (connected) {
        statusElement.removeClass('websocket-disconnected').addClass('websocket-connected');
        statusElement.html('<i class="fas fa-wifi me-1"></i><span>Connected</span>');
    } else {
        statusElement.removeClass('websocket-connected').addClass('websocket-disconnected');
        statusElement.html('<i class="fas fa-wifi me-1"></i><span>Disconnected</span>');
    }
}

// Handle WebSocket messages
function handleWebSocketMessage(data) {
    switch (data.type) {
        case 'price_update':
            updatePriceDisplay(data.symbol, data.price, data.change);
            break;
        case 'order_update':
            updateOrderStatus(data.order);
            break;
        case 'position_update':
            updatePositions(data.positions);
            break;
        case 'balance_update':
            updateBalance(data.balance);
            break;
    }
}

// Setup event listeners
function setupEventListeners() {
    // Sidebar toggle
    $('#toggleSidebar').click(toggleSidebar);
    
    // Navigation links
    $('.nav-link[data-section]').click(function(e) {
        e.preventDefault();
        const section = $(this).data('section');
        showSection(section);
    });
    
    // Timeframe buttons
    $('.timeframe-btn').click(function() {
        $('.timeframe-btn').removeClass('active');
        $(this).addClass('active');
        currentTimeframe = $(this).data('timeframe');
        updateTradingChart();
    });
    
    // Investment amount calculation
    $('#investmentAmount').on('input', calculateExpectedProfit);
    
    // Trading volume and risk calculation
    $('#tradeVolume, #tradeLeverage').on('input', calculateRisk);
    
    // Instrument search
    $('#instrumentSearch').on('input', filterInstruments);
    
    // Auto-calculate take profit and stop loss
    $('#takeProfit, #stopLoss').on('focus', function() {
        if (!$(this).val()) {
            autoCalculateLevels();
        }
    });
}

// Toggle sidebar
function toggleSidebar() {
    const sidebar = $('#sidebar');
    const mainContent = $('#mainContent');
    const icon = $('#toggleSidebar i');
    
    sidebar.toggleClass('collapsed');
    mainContent.toggleClass('expanded');
    
    if (sidebar.hasClass('collapsed')) {
        icon.removeClass('fa-bars').addClass('fa-chevron-right');
    } else {
        icon.removeClass('fa-chevron-right').addClass('fa-bars');
    }
}

// Show specific section
function showSection(section) {
    // Hide all sections
    $('#dashboardSection, #tradingSection, #otherSections').hide();
    
    // Update active nav link
    $('.nav-link').removeClass('active');
    $(`.nav-link[data-section="${section}"]`).addClass('active');
    
    // Update page title
    const titles = {
        dashboard: 'Dashboard',
        trading: 'Trading Room',
        deposit: 'Deposit Funds',
        invest: 'Investment Plans',
        transactions: 'Transaction History',
        earnings: 'Earnings Report',
        reports: 'Analytics Reports',
        settings: 'Account Settings'
    };
    $('#pageTitle').text(titles[section] || 'Dashboard');
    
    // Show selected section
    switch (section) {
        case 'dashboard':
            $('#dashboardSection').show();
            loadDashboardData();
            break;
        case 'trading':
            $('#tradingSection').show();
            initializeTradingRoom();
            break;
        case 'deposit':
            $('#otherSections').show();
            loadDepositSection();
            break;
        case 'invest':
            $('#otherSections').show();
            loadInvestSection();
            break;
        case 'transactions':
            $('#otherSections').show();
            loadTransactionsSection();
            break;
        case 'earnings':
            $('#otherSections').show();
            loadEarningsSection();
            break;
        case 'reports':
            $('#otherSections').show();
            loadReportsSection();
            break;
        case 'settings':
            $('#otherSections').show();
            loadSettingsSection();
            break;
        default:
            $('#otherSections').show();
            loadSectionContent(section);
            break;
    }
}

// Load dashboard data
async function loadDashboardData() {
    showLoading(true);
    
    try {
        // Fetch user data from backend
        await fetchUserData();
        
        // Fetch additional dashboard data
        const [notificationsResponse, investmentsResponse, transactionsResponse] = await Promise.all([
            fetch(`${API_BASE_URL}/user/notifications`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            }),
            fetch(`${API_BASE_URL}/user/investments`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            }),
            fetch(`${API_BASE_URL}/user/transactions`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            })
        ]);

        // Update quick stats
        $('#quickWeekEarnings').text('$' + (Math.random() * 1000 + 500).toFixed(2));
        $('#quickReferrals').text(Math.floor(Math.random() * 20));
        
        // Update wallet changes
        $('#walletChange').text('+' + (Math.random() * 5 + 1).toFixed(1) + '%');
        $('#depositChange').text('+' + (Math.random() * 3 + 1).toFixed(1) + '%');
        $('#investmentChange').text('+' + (Math.random() * 8 + 2).toFixed(1) + '%');
        $('#profitChange').text('+' + (Math.random() * 12 + 3).toFixed(1) + '%');
        
        // Initialize charts and load data
        initializeEarningsChart();
        loadRecentActivity();
        await loadActiveInvestments();
        await loadNotifications();
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        // Fallback to demo data
        loadDemoDashboardData();
    } finally {
        showLoading(false);
    }
}

// Demo data fallback
function loadDemoDashboardData() {
    $('#quickWeekEarnings').text('$' + (Math.random() * 1000 + 500).toFixed(2));
    $('#quickReferrals').text(Math.floor(Math.random() * 20));
    
    $('#walletChange').text('+' + (Math.random() * 5 + 1).toFixed(1) + '%');
    $('#depositChange').text('+' + (Math.random() * 3 + 1).toFixed(1) + '%');
    $('#investmentChange').text('+' + (Math.random() * 8 + 2).toFixed(1) + '%');
    $('#profitChange').text('+' + (Math.random() * 12 + 3).toFixed(1) + '%');
    
    initializeEarningsChart();
    loadRecentActivity();
    loadActiveInvestments();
    loadNotifications();
}

// Initialize earnings chart
function initializeEarningsChart() {
    const ctx = document.getElementById('earningsChart').getContext('2d');
    
    if (earningsChart) {
        earningsChart.destroy();
    }
    
    const data = {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        datasets: [{
            label: 'Earnings',
            data: [1200, 1900, 1500, 2200, 1800, 2500, 3000, 2800, 3200, 3500, 4000, 4500],
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }]
    };
    
    earningsChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Load recent activity
async function loadRecentActivity() {
    try {
        const response = await fetch(`${API_BASE_URL}/user/transactions?type=all&limit=5`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                displayRecentActivity(result.data);
                return;
            }
        }
    } catch (error) {
        console.error('Error loading recent activity:', error);
    }
    
    // Fallback to demo data
    displayDemoRecentActivity();
}

function displayRecentActivity(transactions) {
    const html = transactions.map(transaction => {
        const icon = getTransactionIcon(transaction.type);
        const amountClass = transaction.amount >= 0 ? 'text-success' : 'text-warning';
        const amountPrefix = transaction.amount >= 0 ? '+' : '';
        
        return `
            <div class="d-flex align-items-center mb-3">
                <div class="flex-shrink-0">
                    <i class="${icon} fa-lg"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <div class="fw-bold">${getTransactionMessage(transaction)}</div>
                    <div class="text-muted small">${formatTime(transaction.createdAt)}</div>
                </div>
                <div class="flex-shrink-0">
                    <span class="fw-bold ${amountClass}">
                        ${amountPrefix}$${Math.abs(transaction.amount).toLocaleString()}
                    </span>
                </div>
            </div>
        `;
    }).join('');
    
    $('#recentActivity').html(html);
}

function displayDemoRecentActivity() {
    const activities = [
        { type: 'investment', message: 'New investment in VIP Plan', amount: '+$2,000', time: '2 hours ago', icon: 'fas fa-chart-line text-success' },
        { type: 'deposit', message: 'Deposit received', amount: '+$5,000', time: '5 hours ago', icon: 'fas fa-wallet text-primary' },
        { type: 'withdrawal', message: 'Withdrawal processed', amount: '-$1,000', time: '1 day ago', icon: 'fas fa-money-bill-wave text-warning' },
        { type: 'profit', message: 'Daily profit earned', amount: '+$150', time: '2 days ago', icon: 'fas fa-coins text-success' },
        { type: 'referral', message: 'New referral joined', amount: '+$50', time: '3 days ago', icon: 'fas fa-user-plus text-info' }
    ];
    
    const html = activities.map(activity => `
        <div class="d-flex align-items-center mb-3">
            <div class="flex-shrink-0">
                <i class="${activity.icon} fa-lg"></i>
            </div>
            <div class="flex-grow-1 ms-3">
                <div class="fw-bold">${activity.message}</div>
                <div class="text-muted small">${activity.time}</div>
            </div>
            <div class="flex-shrink-0">
                <span class="fw-bold ${activity.amount.startsWith('+') ? 'text-success' : 'text-warning'}">
                    ${activity.amount}
                </span>
            </div>
        </div>
    `).join('');
    
    $('#recentActivity').html(html);
}

// Load active investments
async function loadActiveInvestments() {
    try {
        const response = await fetch(`${API_BASE_URL}/user/investments`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                displayActiveInvestments(result.data);
                return;
            }
        }
    } catch (error) {
        console.error('Error loading investments:', error);
    }
    
    // Fallback to demo data
    displayDemoActiveInvestments();
}

function displayActiveInvestments(investments) {
    const activeInvestments = investments.filter(inv => inv.status === 'active');
    
    if (activeInvestments.length === 0) {
        $('#investmentsTable').html(`
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-folder-open fa-2x mb-2"></i>
                    <p>No active investments found</p>
                </td>
            </tr>
        `);
        return;
    }
    
    const html = activeInvestments.map(inv => `
        <tr>
            <td>${inv.planName}</td>
            <td>$${inv.amount.toLocaleString()}</td>
            <td>${inv.profitRate}%</td>
            <td>${formatDate(inv.startDate)}</td>
            <td>${formatDate(inv.endDate)}</td>
            <td><span class="badge bg-success">${inv.status}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewInvestmentDetails('${inv._id}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    $('#investmentsTable').html(html);
}

function displayDemoActiveInvestments() {
    const investments = [
        { plan: 'VIP Plan', amount: 5000, rate: '12%', start: '2024-01-15', end: '2024-02-15', status: 'active' },
        { plan: 'Premium Plan', amount: 2000, rate: '8%', start: '2024-01-20', end: '2024-02-20', status: 'active' },
        { plan: 'Basic Plan', amount: 200, rate: '5%', start: '2024-01-25', end: '2024-02-25', status: 'active' }
    ];
    
    const html = investments.map(inv => `
        <tr>
            <td>${inv.plan}</td>
            <td>$${inv.amount.toLocaleString()}</td>
            <td>${inv.rate}</td>
            <td>${inv.start}</td>
            <td>${inv.end}</td>
            <td><span class="badge bg-success">${inv.status}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewInvestmentDetails('${inv.amount}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    $('#investmentsTable').html(html);
}

// Load notifications
async function loadNotifications() {
    try {
        const response = await fetch(`${API_BASE_URL}/user/notifications`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                displayNotifications(result.data.notifications);
                $('#notificationCount').text(result.data.unreadCount);
                return;
            }
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
    
    // Fallback to demo data
    displayDemoNotifications();
}

function displayNotifications(notifications) {
    const html = notifications.slice(0, 5).map(notif => `
        <div class="notification-item ${!notif.isRead ? 'unread' : ''}">
            <div class="fw-bold">${notif.title}</div>
            <div class="small text-muted">${notif.content}</div>
            <div class="small text-muted mt-1">${formatTime(notif.createdAt)}</div>
        </div>
    `).join('');
    
    $('#notificationList').html(html);
}

function displayDemoNotifications() {
    const notifications = [
        { id: 1, title: 'New Investment Opportunity', message: 'VIP Plan now offers 15% returns', time: '10 min ago', unread: true },
        { id: 2, title: 'Withdrawal Processed', message: 'Your withdrawal of $1,000 has been processed', time: '2 hours ago', unread: true },
        { id: 3, title: 'Referral Bonus', message: 'You earned $50 from a new referral', time: '1 day ago', unread: false },
        { id: 4, title: 'Account Update', message: 'Please verify your email address', time: '2 days ago', unread: false }
    ];
    
    const unreadCount = notifications.filter(n => n.unread).length;
    $('#notificationCount').text(unreadCount);
    
    const html = notifications.map(notif => `
        <div class="notification-item ${notif.unread ? 'unread' : ''}">
            <div class="fw-bold">${notif.title}</div>
            <div class="small text-muted">${notif.message}</div>
            <div class="small text-muted mt-1">${notif.time}</div>
        </div>
    `).join('');
    
    $('#notificationList').html(html);
}

// Section Loaders
async function loadDepositSection() {
    $('#otherSections').html(`
        <div class="container-fluid py-4">
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <h3>Deposit Funds</h3>
                        <p class="text-muted">Add funds to your account to start investing</p>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Make a Deposit</h5>
                                        <form id="depositSectionForm">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Amount (USD)</label>
                                                    <input type="number" class="form-control" name="amount" required min="10" value="100">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Payment Method</label>
                                                    <select class="form-select" name="paymentMethod" required>
                                                        <option value="bitcoin">Bitcoin</option>
                                                        <option value="tether">USDT (TRC20)</option>
                                                        <option value="bank">Bank Transfer</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Wallet Address</label>
                                                <input type="text" class="form-control" name="walletAddress" required placeholder="Enter your wallet address">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Proof of Payment</label>
                                                <input type="file" class="form-control" name="proof" accept="image/*,.pdf" required>
                                                <small class="text-muted">Upload screenshot or PDF of transaction</small>
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="submitDepositFromSection()">
                                                Submit Deposit Request
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Deposit History</h5>
                                        <div id="depositHistory">
                                            Loading...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `);
    
    await loadDepositHistory();
}

async function loadDepositHistory() {
    try {
        const response = await fetch(`${API_BASE_URL}/user/transactions?type=deposit`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                displayDepositHistory(result.data);
                return;
            }
        }
    } catch (error) {
        console.error('Error loading deposit history:', error);
    }
    
    $('#depositHistory').html('<p class="text-muted">No deposit history found</p>');
}

function displayDepositHistory(transactions) {
    if (transactions.length === 0) {
        $('#depositHistory').html('<p class="text-muted">No deposit history found</p>');
        return;
    }
    
    const html = transactions.map(transaction => `
        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
            <div>
                <div class="fw-bold">$${transaction.amount.toLocaleString()}</div>
                <small class="text-muted">${formatDate(transaction.createdAt)}</small>
            </div>
            <span class="badge ${getStatusBadgeClass(transaction.status)}">
                ${transaction.status}
            </span>
        </div>
    `).join('');
    
    $('#depositHistory').html(html);
}

async function loadInvestSection() {
    $('#otherSections').html(`
        <div class="container-fluid py-4">
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <h3>Investment Plans</h3>
                        <p class="text-muted">Choose an investment plan that suits your goals</p>
                        
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="investment-plan" data-plan="1" onclick="selectPlan(1)">
                                    <div class="plan-name">Basic Plan</div>
                                    <div class="plan-rate">5%</div>
                                    <div class="text-muted">30 days</div>
                                    <small>$50 - $1,000</small>
                                    <ul class="plan-features">
                                        <li>24/7 Support</li>
                                        <li>Basic Analytics</li>
                                        <li>Email Reports</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="investment-plan" data-plan="2" onclick="selectPlan(2)">
                                    <div class="plan-name">Premium Plan</div>
                                    <div class="plan-rate">8%</div>
                                    <div class="text-muted">30 days</div>
                                    <small>$1,001 - $5,000</small>
                                    <ul class="plan-features">
                                        <li>Priority Support</li>
                                        <li>Advanced Analytics</li>
                                        <li>Daily Reports</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="investment-plan" data-plan="3" onclick="selectPlan(3)">
                                    <div class="plan-name">VIP Plan</div>
                                    <div class="plan-rate">12%</div>
                                    <div class="text-muted">30 days</div>
                                    <small>$5,001 - $20,000</small>
                                    <ul class="plan-features">
                                        <li>Dedicated Manager</li>
                                        <li>Real-time Analytics</li>
                                        <li>Custom Reports</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Active Investments</h5>
                                <div id="allInvestmentsList">
                                    Loading...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `);
    
    await loadAllInvestments();
}

async function loadAllInvestments() {
    try {
        const response = await fetch(`${API_BASE_URL}/user/investments`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                displayAllInvestments(result.data);
                return;
            }
        }
    } catch (error) {
        console.error('Error loading investments:', error);
    }
    
    $('#allInvestmentsList').html('<p class="text-muted">No investments found</p>');
}

function displayAllInvestments(investments) {
    if (investments.length === 0) {
        $('#allInvestmentsList').html('<p class="text-muted">No investments found</p>');
        return;
    }
    
    const html = investments.map(inv => `
        <div class="d-flex justify-content-between align-items-center border-bottom py-3">
            <div>
                <div class="fw-bold">${inv.planName}</div>
                <small class="text-muted">Amount: $${inv.amount.toLocaleString()} | Rate: ${inv.profitRate}%</small>
            </div>
            <div class="text-end">
                <span class="badge ${getInvestmentStatusBadgeClass(inv.status)} me-2">
                    ${inv.status}
                </span>
                <div>
                    <small class="text-muted">${formatDate(inv.startDate)} - ${formatDate(inv.endDate)}</small>
                </div>
            </div>
        </div>
    `).join('');
    
    $('#allInvestmentsList').html(html);
}

async function loadTransactionsSection() {
    $('#otherSections').html(`
        <div class="container-fluid py-4">
            <div class="row">
                <div class="col-12">
                    <div class="table-card">
                        <div class="card-header bg-transparent">
                            <h5 class="mb-0">Transaction History</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <select class="form-select" id="transactionFilter" onchange="filterTransactions()">
                                        <option value="all">All Transactions</option>
                                        <option value="deposit">Deposits</option>
                                        <option value="withdrawal">Withdrawals</option>
                                        <option value="investment">Investments</option>
                                        <option value="profit">Profits</option>
                                    </select>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Amount</th>
                                            <th>Description</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsTable">
                                        Loading...
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `);
    
    await loadAllTransactions();
}

async function loadAllTransactions() {
    try {
        const response = await fetch(`${API_BASE_URL}/user/transactions?type=all`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                window.allTransactions = result.data; // Store for filtering
                displayTransactions(result.data);
                return;
            }
        }
    } catch (error) {
        console.error('Error loading transactions:', error);
    }
    
    $('#transactionsTable').html('<tr><td colspan="5" class="text-center text-muted">No transactions found</td></tr>');
}

function displayTransactions(transactions) {
    if (transactions.length === 0) {
        $('#transactionsTable').html('<tr><td colspan="5" class="text-center text-muted">No transactions found</td></tr>');
        return;
    }
    
    const html = transactions.map(transaction => `
        <tr>
            <td>${formatDate(transaction.createdAt)}</td>
            <td>
                <span class="badge ${getTransactionTypeBadgeClass(transaction.type)}">
                    ${transaction.type}
                </span>
            </td>
            <td class="${transaction.amount >= 0 ? 'text-success' : 'text-danger'}">
                ${transaction.amount >= 0 ? '+' : ''}$${Math.abs(transaction.amount).toLocaleString()}
            </td>
            <td>${getTransactionDescription(transaction)}</td>
            <td>
                <span class="badge ${getStatusBadgeClass(transaction.status)}">
                    ${transaction.status}
                </span>
            </td>
        </tr>
    `).join('');
    
    $('#transactionsTable').html(html);
}

function filterTransactions() {
    const filter = $('#transactionFilter').val();
    let filteredTransactions = window.allTransactions || [];
    
    if (filter !== 'all') {
        filteredTransactions = filteredTransactions.filter(t => t.type === filter);
    }
    
    displayTransactions(filteredTransactions);
}

async function loadEarningsSection() {
    $('#otherSections').html(`
        <div class="container-fluid py-4">
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <h3>Earnings Report</h3>
                        <p class="text-muted">Track your earnings and profits</p>
                        
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4>$${(currentUser?.totalProfit || 0).toLocaleString()}</h4>
                                        <p>Total Profit</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h4>$${(currentUser?.totalInvested || 0).toLocaleString()}</h4>
                                        <p>Total Invested</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4>${calculateROI()}%</h4>
                                        <p>ROI</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h4>$${(currentUser?.walletBalance || 0).toLocaleString()}</h4>
                                        <p>Available Balance</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Earnings Breakdown</h5>
                                <div id="earningsBreakdown">
                                    Loading...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `);
    
    await loadEarningsBreakdown();
}

function calculateROI() {
    if (!currentUser || !currentUser.totalInvested || currentUser.totalInvested === 0) return 0;
    return ((currentUser.totalProfit / currentUser.totalInvested) * 100).toFixed(2);
}

async function loadEarningsBreakdown() {
    try {
        const response = await fetch(`${API_BASE_URL}/user/earnings-breakdowns`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                displayEarningsBreakdown(result.data.earnings);
                return;
            }
        }
    } catch (error) {
        console.error('Error loading earnings breakdown:', error);
    }
    
    $('#earningsBreakdown').html('<p class="text-muted">No earnings data available</p>');
}

function displayEarningsBreakdown(earnings) {
    if (earnings.length === 0) {
        $('#earningsBreakdown').html('<p class="text-muted">No earnings data available</p>');
        return;
    }
    
    const html = earnings.map(earning => `
        <div class="d-flex justify-content-between align-items-center border-bottom py-3">
            <div>
                <div class="fw-bold">${earning.period.charAt(0).toUpperCase() + earning.period.slice(1)} Earnings</div>
                <small class="text-muted">
                    ${formatDate(earning.startDate)} - ${formatDate(earning.endDate)}
                </small>
            </div>
            <div class="text-end">
                <div class="fw-bold text-success">$${earning.totalEarnings.toLocaleString()}</div>
                <small class="text-muted">
                    Profit: $${earning.profit.toLocaleString()} | 
                    Deposit: $${earning.deposit.toLocaleString()} | 
                    Investment: $${earning.investment.toLocaleString()}
                </small>
            </div>
        </div>
    `).join('');
    
    $('#earningsBreakdown').html(html);
}

async function loadReportsSection() {
    $('#otherSections').html(`
        <div class="container-fluid py-4">
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <h3>Analytics Reports</h3>
                        <p class="text-muted">Detailed reports and analytics</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Transaction Reports</h5>
                                        <div id="transactionReports">
                                            Loading...
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Performance Metrics</h5>
                                        <canvas id="performanceChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `);
    
    await loadTransactionReports();
    initializePerformanceChart();
}

async function loadTransactionReports() {
    try {
        const response = await fetch(`${API_BASE_URL}/user/transaction-reports`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                displayTransactionReports(result.data.reports);
                return;
            }
        }
    } catch (error) {
        console.error('Error loading transaction reports:', error);
    }
    
    $('#transactionReports').html('<p class="text-muted">No reports available</p>');
}

function displayTransactionReports(reports) {
    if (reports.length === 0) {
        $('#transactionReports').html('<p class="text-muted">No reports available</p>');
        return;
    }
    
    const html = reports.map(report => `
        <div class="border-bottom py-2">
            <div class="fw-bold">${report.title}</div>
            <small class="text-muted">${report.description || 'No description'}</small>
            <div class="mt-1">
                <small class="text-muted">Generated: ${formatDate(report.createdAt)}</small>
            </div>
        </div>
    `).join('');
    
    $('#transactionReports').html(html);
}

function initializePerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Investments', 'Profits', 'Deposits', 'Withdrawals'],
            datasets: [{
                data: [currentUser?.totalInvested || 0, currentUser?.totalProfit || 0, 5000, 1000],
                backgroundColor: ['#3498db', '#27ae60', '#f39c12', '#e74c3c']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function loadSettingsSection() {
    $('#otherSections').html(`
        <div class="container-fluid py-4">
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <h3>Account Settings</h3>
                        <p class="text-muted">Manage your account preferences and security</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Profile Information</h5>
                                        <button class="btn btn-primary" onclick="showProfileModal()">
                                            <i class="fas fa-edit me-2"></i>Edit Profile
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="card mt-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Security Settings</h5>
                                        <div class="mb-3">
                                            <label class="form-label">Change Password</label>
                                            <input type="password" class="form-control" placeholder="New password">
                                        </div>
                                        <button class="btn btn-warning">Update Password</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Account Statistics</h5>
                                        <div class="mb-2">
                                            <strong>Member Since:</strong> 
                                            <span class="text-muted">${formatDate(currentUser?.createdAt)}</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Total Transactions:</strong> 
                                            <span class="text-muted" id="totalTransactionsCount">Loading...</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Account Status:</strong> 
                                            <span class="badge bg-success">Active</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mt-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Notification Preferences</h5>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                            <label class="form-check-label" for="emailNotifications">
                                                Email Notifications
                                            </label>
                                        </div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="smsNotifications">
                                            <label class="form-check-label" for="smsNotifications">
                                                SMS Notifications
                                            </label>
                                        </div>
                                        <button class="btn btn-info">Save Preferences</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `);
    
    loadAccountStatistics();
}

async function loadAccountStatistics() {
    try {
        const response = await fetch(`${API_BASE_URL}/user/transactions?type=all`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                $('#totalTransactionsCount').text(result.data.length);
                return;
            }
        }
    } catch (error) {
        console.error('Error loading account statistics:', error);
    }
    
    $('#totalTransactionsCount').text('0');
}

// Utility Functions
function getTransactionIcon(type) {
    const icons = {
        'deposit': 'fas fa-wallet text-primary',
        'withdrawal': 'fas fa-money-bill-wave text-warning',
        'investment': 'fas fa-chart-line text-success',
        'profit': 'fas fa-coins text-success',
        'admin_adjustment': 'fas fa-cog text-info'
    };
    return icons[type] || 'fas fa-exchange-alt text-info';
}

function getTransactionMessage(transaction) {
    const messages = {
        'deposit': 'Deposit received',
        'withdrawal': 'Withdrawal processed',
        'investment': 'Investment made',
        'profit': 'Profit earned',
        'admin_adjustment': 'Admin adjustment'
    };
    return messages[transaction.type] || 'Transaction completed';
}

function getStatusBadgeClass(status) {
    const classes = {
        'pending': 'bg-warning',
        'approved': 'bg-success',
        'rejected': 'bg-danger'
    };
    return classes[status] || 'bg-secondary';
}

function getTransactionTypeBadgeClass(type) {
    const classes = {
        'deposit': 'bg-primary',
        'withdrawal': 'bg-warning',
        'investment': 'bg-info',
        'profit': 'bg-success',
        'admin_adjustment': 'bg-secondary'
    };
    return classes[type] || 'bg-dark';
}

function getInvestmentStatusBadgeClass(status) {
    const classes = {
        'active': 'bg-success',
        'completed': 'bg-info',
        'cancelled': 'bg-danger'
    };
    return classes[status] || 'bg-secondary';
}

function getTransactionDescription(transaction) {
    if (transaction.investmentPlan) {
        return `Investment in ${transaction.investmentPlan}`;
    }
    if (transaction.adminNote) {
        return transaction.adminNote;
    }
    return `${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)} transaction`;
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function formatTime(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes} min ago`;
    if (hours < 24) return `${hours} hours ago`;
    if (days < 7) return `${days} days ago`;
    
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric'
    });
}

// Trading Room Functions (keep your existing trading functions)
function initializeTradingRoom() {
    loadInstruments();
    initializeTradingChart();
    updatePositions();
    simulateOrderBook();
    startPriceUpdates();
}

// ... (keep all your existing trading room functions as they are)

// Deposit and Investment Functions
async function submitDepositFromSection() {
    const form = document.getElementById('depositSectionForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch(`${API_BASE_URL}/deposits`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showToast('Deposit submitted successfully', 'success');
                form.reset();
                await loadDepositHistory();
                await fetchUserData(); // Refresh user data
            } else {
                throw new Error(result.message);
            }
        } else {
            throw new Error('Failed to submit deposit');
        }
    } catch (error) {
        console.error('Error submitting deposit:', error);
        showToast('Failed to submit deposit: ' + error.message, 'danger');
    }
}

async function submitInvestment() {
    const amount = parseFloat($('#investmentAmount').val());
    const planId = selectedPlan;
    
    if (!amount || !planId) {
        showToast('Please select a plan and enter amount', 'warning');
        return;
    }
    
    if (amount > currentUser.depositBalance) {
        showToast('Insufficient deposit balance', 'danger');
        return;
    }
    
    showLoading(true);
    
    try {
        const response = await fetch(`${API_BASE_URL}/investments`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                planId: planId.toString(),
                amount: amount
            })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showToast('Investment request submitted successfully', 'success');
                $('#investmentModal').modal('hide');
                await fetchUserData(); // Refresh user data
                if (window.currentSection === 'invest') {
                    await loadAllInvestments();
                }
            } else {
                throw new Error(result.message);
            }
        } else {
            throw new Error('Failed to submit investment');
        }
    } catch (error) {
        console.error('Error submitting investment:', error);
        showToast('Failed to submit investment: ' + error.message, 'danger');
    } finally {
        showLoading(false);
    }
}

// Update profile function
async function updateProfile() {
    const name = $('#profileName').val();
    const bitcoinAccount = $('#profileBitcoin').val();
    const tetherAccount = $('#profileTether').val();
    const secretQuestion = $('#profileQuestion').val();
    const secretAnswer = $('#profileAnswer').val();
    
    if (!name || !secretQuestion || !secretAnswer) {
        showToast('Please fill all required fields', 'warning');
        return;
    }
    
    showLoading(true);
    
    try {
        const response = await fetch(`${API_BASE_URL}/user/profile`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                bitcoinAccount: bitcoinAccount,
                tetherTRC20Account: tetherAccount,
                secretQuestion: secretQuestion,
                secretAnswer: secretAnswer
            })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showToast('Profile updated successfully', 'success');
                $('#profileModal').modal('hide');
                await fetchUserData(); // Refresh user data
            } else {
                throw new Error(result.message);
            }
        } else {
            throw new Error('Failed to update profile');
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        showToast('Failed to update profile: ' + error.message, 'danger');
    } finally {
        showLoading(false);
    }
}

// Show loading spinner
function showLoading(show) {
    if (show) {
        $('#loadingSpinner').fadeIn();
    } else {
        $('#loadingSpinner').fadeOut();
    }
}

// Show toast notification
function showToast(message, type) {
    const toastId = 'toast-' + Date.now();
    const toast = $(`
        <div class="toast align-items-center text-white bg-${type} border-0" id="${toastId}">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `);
    
    $('#toastContainer').append(toast);
    const bsToast = new bootstrap.Toast(toast[0]);
    bsToast.show();
    
    toast.on('hidden.bs.toast', function() {
        $(this).remove();
    });
}

// Logout function
function logout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('userData');
        window.location.href = 'login.html';
    }
}

// Initialize the application
$(document).ready(function() {
    console.log('WCTRADE Platform initialized');
    // Store current section for refresh purposes
    window.currentSection = 'dashboard';
});


   // Authentication check
function checkAuthentication() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'login.html';
        return;
    }
    
    // In a real app, you would verify the token with your backend
    try {
        const userData = JSON.parse(localStorage.getItem('userData'));
        if (userData) {
            currentUser = userData;
            updateUserInterface();
        } else {
            // Mock user data for demo
            currentUser = {
                id: 1,
                name: 'John Doe',
                email: 'john.doe@example.com',
                walletBalance: 12500.75,
                depositBalance: 8500.00,
                totalInvested: 7200.00,
                totalProfit: 3250.50,
                referralCode: 'GALAXY123',
                bitcoinAccount: '',
                tetherTRC20Account: '',
                secretQuestion: 'What is your mother\'s maiden name?',
                secretAnswer: ''
            };
            localStorage.setItem('userData', JSON.stringify(currentUser));
            updateUserInterface();
        }
    } catch (error) {
        console.error('Error loading user data:', error);
        window.location.href = 'login.html';
    }
}

// Update user interface with user data
function updateUserInterface() {
    if (!currentUser) return;
    
    $('#userName').text(currentUser.name);
    $('#userAvatar').text(currentUser.name.split(' ').map(n => n[0]).join(''));
    $('#walletBalance').text('$' + currentUser.walletBalance.toLocaleString());
    $('#depositBalance').text('$' + currentUser.depositBalance.toLocaleString());
    $('#totalInvested').text('$' + currentUser.totalInvested.toLocaleString());
    $('#totalProfit').text('$' + currentUser.totalProfit.toLocaleString());
    $('#tradingBalance').text('$' + currentUser.walletBalance.toLocaleString());
    $('#freeMargin').text('$' + (currentUser.walletBalance * 0.8).toLocaleString());
    $('#availableDeposit').text(currentUser.depositBalance.toLocaleString());
    $('#referralCode').val(currentUser.referralCode);
    $('#referralLink').val(`${window.location.origin}/register?ref=${currentUser.referralCode}`);
    
    // Profile form
    $('#profileName').val(currentUser.name);
    $('#profileEmail').val(currentUser.email);
    $('#profileBitcoin').val(currentUser.bitcoinAccount);
    $('#profileTether').val(currentUser.tetherTRC20Account);
    $('#profileQuestion').val(currentUser.secretQuestion);
}

// Initialize WebSocket connection
function initializeWebSocket() {
    try {
        // In a real application, you would connect to your WebSocket server
        // websocket = new WebSocket('wss://your-websocket-server.com');
        
        // For demo purposes, we'll simulate WebSocket behavior
        simulateWebSocketConnection();
        
        // WebSocket event handlers
        websocket.onopen = function() {
            updateWebSocketStatus(true);
            console.log('WebSocket connected');
        };
        
        websocket.onclose = function() {
            updateWebSocketStatus(false);
            console.log('WebSocket disconnected');
            // Attempt to reconnect after 5 seconds
            setTimeout(initializeWebSocket, 5000);
        };
        
        websocket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            handleWebSocketMessage(data);
        };
        
        websocket.onerror = function(error) {
            console.error('WebSocket error:', error);
            updateWebSocketStatus(false);
        };
        
    } catch (error) {
        console.error('WebSocket initialization failed:', error);
        updateWebSocketStatus(false);
    }
}

// Simulate WebSocket for demo
function simulateWebSocketConnection() {
    websocket = {
        connected: true,
        onopen: null,
        onclose: null,
        onmessage: null,
        onerror: null,
        send: function(data) {
            console.log('WebSocket send:', data);
            // Simulate response
            setTimeout(() => {
                if (this.onmessage) {
                    const parsedData = JSON.parse(data);
                    const response = this.simulateResponse(parsedData);
                    this.onmessage({ data: JSON.stringify(response) });
                }
            }, 100);
        },
        close: function() {
            this.connected = false;
            if (this.onclose) this.onclose();
        },
        simulateResponse: function(data) {
            // Simulate various responses based on the request
            if (data.type === 'subscribe' && data.channel === 'prices') {
                return {
                    type: 'price_update',
                    symbol: data.symbol,
                    price: (Math.random() * 1000 + 40000).toFixed(2),
                    change: (Math.random() - 0.5) * 10
                };
            }
            return { type: 'ack', success: true };
        }
    };
    
    // Simulate connection opening
    setTimeout(() => {
        if (websocket.onopen) websocket.onopen();
    }, 1000);
}

// Update WebSocket status indicator
function updateWebSocketStatus(connected) {
    const statusElement = $('#websocketStatus');
    if (connected) {
        statusElement.removeClass('websocket-disconnected').addClass('websocket-connected');
        statusElement.html('<i class="fas fa-wifi me-1"></i><span>Connected</span>');
    } else {
        statusElement.removeClass('websocket-connected').addClass('websocket-disconnected');
        statusElement.html('<i class="fas fa-wifi me-1"></i><span>Disconnected</span>');
    }
}

// Handle WebSocket messages
function handleWebSocketMessage(data) {
    switch (data.type) {
        case 'price_update':
            updatePriceDisplay(data.symbol, data.price, data.change);
            break;
        case 'order_update':
            updateOrderStatus(data.order);
            break;
        case 'position_update':
            updatePositions(data.positions);
            break;
        case 'balance_update':
            updateBalance(data.balance);
            break;
    }
}

// Setup event listeners
function setupEventListeners() {
    // Sidebar toggle
    $('#toggleSidebar').click(toggleSidebar);
    
    // Navigation links
    $('.nav-link[data-section]').click(function(e) {
        e.preventDefault();
        const section = $(this).data('section');
        showSection(section);
    });
    
    // Timeframe buttons
    $('.timeframe-btn').click(function() {
        $('.timeframe-btn').removeClass('active');
        $(this).addClass('active');
        currentTimeframe = $(this).data('timeframe');
        updateTradingChart();
    });
    
    // Investment amount calculation
    $('#investmentAmount').on('input', calculateExpectedProfit);
    
    // Trading volume and risk calculation
    $('#tradeVolume, #tradeLeverage').on('input', calculateRisk);
    
    // Instrument search
    $('#instrumentSearch').on('input', filterInstruments);
    
    // Auto-calculate take profit and stop loss
    $('#takeProfit, #stopLoss').on('focus', function() {
        if (!$(this).val()) {
            autoCalculateLevels();
        }
    });
}

// Toggle sidebar
function toggleSidebar() {
    const sidebar = $('#sidebar');
    const mainContent = $('#mainContent');
    const icon = $('#toggleSidebar i');
    
    sidebar.toggleClass('collapsed');
    mainContent.toggleClass('expanded');
    
    if (sidebar.hasClass('collapsed')) {
        icon.removeClass('fa-bars').addClass('fa-chevron-right');
    } else {
        icon.removeClass('fa-chevron-right').addClass('fa-bars');
    }
}

// Show specific section
function showSection(section) {
    // Hide all sections
    $('#dashboardSection, #tradingSection, #otherSections').hide();
    
    // Update active nav link
    $('.nav-link').removeClass('active');
    $(`.nav-link[data-section="${section}"]`).addClass('active');
    
    // Update page title
    const titles = {
        dashboard: 'Dashboard',
        trading: 'Trading Room',
        deposit: 'Deposit Funds',
        invest: 'Investment Plans',
        transactions: 'Transaction History',
        earnings: 'Earnings Report',
        reports: 'Analytics Reports',
        settings: 'Account Settings'
    };
    $('#pageTitle').text(titles[section] || 'Dashboard');
    
    // Show selected section
    switch (section) {
        case 'dashboard':
            $('#dashboardSection').show();
            loadDashboardData();
            break;
        case 'trading':
            $('#tradingSection').show();
            initializeTradingRoom();
            break;
        default:
            $('#otherSections').show();
            // Load section content dynamically
            loadSectionContent(section);
            break;
    }
}

// Load dashboard data
function loadDashboardData() {
    showLoading(true);
    
    // Simulate API calls
    setTimeout(() => {
        // Update quick stats
        $('#quickWeekEarnings').text('$' + (Math.random() * 1000 + 500).toFixed(2));
        $('#quickReferrals').text(Math.floor(Math.random() * 20));
        
        // Update wallet changes
        $('#walletChange').text('+' + (Math.random() * 5 + 1).toFixed(1) + '%');
        $('#depositChange').text('+' + (Math.random() * 3 + 1).toFixed(1) + '%');
        $('#investmentChange').text('+' + (Math.random() * 8 + 2).toFixed(1) + '%');
        $('#profitChange').text('+' + (Math.random() * 12 + 3).toFixed(1) + '%');
        
        // Initialize charts
        initializeEarningsChart();
        loadRecentActivity();
        loadActiveInvestments();
        loadNotifications();
        
        showLoading(false);
    }, 1000);
}

// Initialize earnings chart
function initializeEarningsChart() {
    const ctx = document.getElementById('earningsChart').getContext('2d');
    
    if (earningsChart) {
        earningsChart.destroy();
    }
    
    const data = {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        datasets: [{
            label: 'Earnings',
            data: [1200, 1900, 1500, 2200, 1800, 2500, 3000, 2800, 3200, 3500, 4000, 4500],
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }]
    };
    
    earningsChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Load recent activity
function loadRecentActivity() {
    const activities = [
        { type: 'investment', message: 'New investment in VIP Plan', amount: '+$2,000', time: '2 hours ago', icon: 'fas fa-chart-line text-success' },
        { type: 'deposit', message: 'Deposit received', amount: '+$5,000', time: '5 hours ago', icon: 'fas fa-wallet text-primary' },
        { type: 'withdrawal', message: 'Withdrawal processed', amount: '-$1,000', time: '1 day ago', icon: 'fas fa-money-bill-wave text-warning' },
        { type: 'profit', message: 'Daily profit earned', amount: '+$150', time: '2 days ago', icon: 'fas fa-coins text-success' },
        { type: 'referral', message: 'New referral joined', amount: '+$50', time: '3 days ago', icon: 'fas fa-user-plus text-info' }
    ];
    
    const html = activities.map(activity => `
        <div class="d-flex align-items-center mb-3">
            <div class="flex-shrink-0">
                <i class="${activity.icon} fa-lg"></i>
            </div>
            <div class="flex-grow-1 ms-3">
                <div class="fw-bold">${activity.message}</div>
                <div class="text-muted small">${activity.time}</div>
            </div>
            <div class="flex-shrink-0">
                <span class="fw-bold ${activity.amount.startsWith('+') ? 'text-success' : 'text-warning'}">
                    ${activity.amount}
                </span>
            </div>
        </div>
    `).join('');
    
    $('#recentActivity').html(html);
}

// Load active investments
function loadActiveInvestments() {
    const investments = [
        { plan: 'VIP Plan', amount: 5000, rate: '12%', start: '2024-01-15', end: '2024-02-15', status: 'active' },
        { plan: 'Premium Plan', amount: 2000, rate: '8%', start: '2024-01-20', end: '2024-02-20', status: 'active' },
        { plan: 'Basic Plan', amount: 200, rate: '5%', start: '2024-01-25', end: '2024-02-25', status: 'active' }
    ];
    
    const html = investments.map(inv => `
        <tr>
            <td>${inv.plan}</td>
            <td>$${inv.amount.toLocaleString()}</td>
            <td>${inv.rate}</td>
            <td>${inv.start}</td>
            <td>${inv.end}</td>
            <td><span class="badge bg-success">${inv.status}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewInvestmentDetails(${inv.amount})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    $('#investmentsTable').html(html);
}

// Load notifications
function loadNotifications() {
    const notifications = [
        { id: 1, title: 'New Investment Opportunity', message: 'VIP Plan now offers 15% returns', time: '10 min ago', unread: true },
        { id: 2, title: 'Withdrawal Processed', message: 'Your withdrawal of $1,000 has been processed', time: '2 hours ago', unread: true },
        { id: 3, title: 'Referral Bonus', message: 'You earned $50 from a new referral', time: '1 day ago', unread: false },
        { id: 4, title: 'Account Update', message: 'Please verify your email address', time: '2 days ago', unread: false }
    ];
    
    const unreadCount = notifications.filter(n => n.unread).length;
    $('#notificationCount').text(unreadCount);
    
    const html = notifications.map(notif => `
        <div class="notification-item ${notif.unread ? 'unread' : ''}">
            <div class="fw-bold">${notif.title}</div>
            <div class="small text-muted">${notif.message}</div>
            <div class="small text-muted mt-1">${notif.time}</div>
        </div>
    `).join('');
    
    $('#notificationList').html(html);
}

// Initialize trading room
function initializeTradingRoom() {
    loadInstruments();
    initializeTradingChart();
    updatePositions();
    simulateOrderBook();
    
    // Start price updates
    startPriceUpdates();
}

// Load trading instruments
function loadInstruments() {
    const instruments = [
        { symbol: 'BTCUSD', name: 'Bitcoin / USD', price: 43250.75, change: 2.5 },
        { symbol: 'ETHUSD', name: 'Ethereum / USD', price: 2580.30, change: 1.8 },
        { symbol: 'XRPUSD', name: 'Ripple / USD', price: 0.5789, change: -0.3 },
        { symbol: 'LTCUSD', name: 'Litecoin / USD', price: 72.45, change: 0.7 },
        { symbol: 'ADAUSD', name: 'Cardano / USD', price: 0.5234, change: 1.2 }
    ];
    
    const html = instruments.map(instr => `
        <div class="instrument-item ${instr.symbol === currentInstrument ? 'active' : ''}" 
             data-symbol="${instr.symbol}" onclick="selectInstrument('${instr.symbol}')">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="fw-bold text-light">${instr.symbol}</div>
                    <small class="text-muted">${instr.name}</small>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-light">$${instr.price.toLocaleString()}</div>
                    <small class="${instr.change >= 0 ? 'price-up' : 'price-down'}">
                        ${instr.change >= 0 ? '+' : ''}${instr.change}%
                    </small>
                </div>
            </div>
        </div>
    `).join('');
    
    $('.instrument-list').html(html);
}

// Select trading instrument
function selectInstrument(symbol) {
    currentInstrument = symbol;
    $('.instrument-item').removeClass('active');
    $(`.instrument-item[data-symbol="${symbol}"]`).addClass('active');
    $('#tradeSymbol').val(symbol);
    updateTradingChart();
    updatePriceDisplay(symbol);
}

// Initialize TradingView chart
function initializeTradingChart() {
    if (typeof TradingView !== 'undefined') {
        tradingChart = new TradingView.widget({
            container_id: "tradingChart",
            autosize: true,
            symbol: "BINANCE:BTCUSDT",
            interval: "1",
            timezone: "Etc/UTC",
            theme: "dark",
            style: "1",
            locale: "en",
            toolbar_bg: "#1e1e1e",
            enable_publishing: false,
            allow_symbol_change: false,
            studies: [
                "BB@tv-basicstudies",
                "RSI@tv-basicstudies"
            ],
            container_id: "tradingChart",
        });
    } else {
        // Fallback: Display message if TradingView fails to load
        $('#tradingChart').html(`
            <div class="d-flex justify-content-center align-items-center h-100 text-muted">
                <div class="text-center">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <p>Trading chart will be displayed here</p>
                    <small>Real-time charts require TradingView integration</small>
                </div>
            </div>
        `);
    }
}

// Update trading chart
function updateTradingChart() {
    // In a real implementation, this would update the TradingView chart
    console.log('Updating chart for', currentInstrument, 'with timeframe', currentTimeframe);
}

// Update price display
function updatePriceDisplay(symbol, price, change) {
    if (!price) {
        // Generate random price for demo
        const instruments = {
            'BTCUSD': 43250 + (Math.random() - 0.5) * 1000,
            'ETHUSD': 2580 + (Math.random() - 0.5) * 50,
            'XRPUSD': 0.5789 + (Math.random() - 0.5) * 0.01,
            'LTCUSD': 72.45 + (Math.random() - 0.5) * 2,
            'ADAUSD': 0.5234 + (Math.random() - 0.5) * 0.02
        };
        price = instruments[symbol] || 43250;
        change = (Math.random() - 0.5) * 5;
    }
    
    $(`.instrument-item[data-symbol="${symbol}"] .fw-bold.text-light`).text('$' + price.toLocaleString());
    $(`.instrument-item[data-symbol="${symbol}"] small`).text((change >= 0 ? '+' : '') + change.toFixed(2) + '%');
    $(`.instrument-item[data-symbol="${symbol}"] small`).removeClass('price-up price-down').addClass(change >= 0 ? 'price-up' : 'price-down');
    
    if (symbol === currentInstrument) {
        $('#currentPrice').text('$' + price.toLocaleString());
    }
}

// Start simulated price updates
function startPriceUpdates() {
    setInterval(() => {
        const symbols = ['BTCUSD', 'ETHUSD', 'XRPUSD', 'LTCUSD', 'ADAUSD'];
        symbols.forEach(symbol => {
            updatePriceDisplay(symbol);
        });
        simulateOrderBook();
    }, 2000);
}

// Simulate order book data
function simulateOrderBook() {
    const basePrice = 43250;
    const bids = [];
    const asks = [];
    
    for (let i = 0; i < 10; i++) {
        const bidPrice = basePrice - (i * 10) - (Math.random() * 5);
        const askPrice = basePrice + (i * 10) + (Math.random() * 5);
        const size = (Math.random() * 5 + 1).toFixed(3);
        
        bids.push({ price: bidPrice.toFixed(2), size });
        asks.push({ price: askPrice.toFixed(2), size });
    }
    
    orderBook = { bids, asks };
    updateOrderBook();
}

// Update order book display
function updateOrderBook() {
    const bidsHtml = orderBook.bids.map(bid => `
        <div class="bid-row">
            <div class="d-flex justify-content-between">
                <span class="price-up">${bid.price}</span>
                <span>${bid.size}</span>
            </div>
        </div>
    `).join('');
    
    const asksHtml = orderBook.asks.map(ask => `
        <div class="ask-row">
            <div class="d-flex justify-content-between">
                <span class="price-down">${ask.price}</span>
                <span>${ask.size}</span>
            </div>
        </div>
    `).join('');
    
    $('#orderBookBids').html(bidsHtml);
    $('#orderBookAsks').html(asksHtml);
}

// Calculate risk
function calculateRisk() {
    const volume = parseFloat($('#tradeVolume').val()) || 0.01;
    const leverage = parseInt($('#tradeLeverage').val()) || 1;
    const balance = currentUser.walletBalance;
    
    const riskAmount = volume * leverage * 1000; // Simplified risk calculation
    const riskPercentage = (riskAmount / balance) * 100;
    
    $('#riskLevel').css('width', Math.min(riskPercentage, 100) + '%');
    $('#riskPercentage').text(riskPercentage.toFixed(1) + '% of balance at risk');
    
    // Update risk color
    const riskLevel = $('#riskLevel');
    riskLevel.removeClass('bg-success bg-warning bg-danger');
    
    if (riskPercentage <= 20) {
        riskLevel.addClass('bg-success');
    } else if (riskPercentage <= 50) {
        riskLevel.addClass('bg-warning');
    } else {
        riskLevel.addClass('bg-danger');
    }
}

// Auto-calculate take profit and stop loss
function autoCalculateLevels() {
    const currentPrice = parseFloat($('#currentPrice').text().replace('$', '').replace(',', '')) || 43250;
    const takeProfit = (currentPrice * 1.02).toFixed(2);
    const stopLoss = (currentPrice * 0.98).toFixed(2);
    
    $('#takeProfit').val(takeProfit);
    $('#stopLoss').val(stopLoss);
}

// Place order
function placeOrder(type) {
    if (tradingSettings.confirmOrders && !confirm(`Are you sure you want to place a ${type.toUpperCase()} order?`)) {
        return;
    }
    
    const symbol = $('#tradeSymbol').val();
    const volume = parseFloat($('#tradeVolume').val());
    const leverage = parseInt($('#tradeLeverage').val());
    const takeProfit = $('#takeProfit').val();
    const stopLoss = $('#stopLoss').val();
    
    if (!volume || volume <= 0) {
        showTradingAlert('Please enter a valid volume', 'danger');
        return;
    }
    
    showLoading(true);
    
    // Simulate order placement
    setTimeout(() => {
        const order = {
            id: Date.now(),
            symbol,
            type,
            volume,
            leverage,
            takeProfit,
            stopLoss,
            status: 'open',
            openTime: new Date().toISOString(),
            openPrice: parseFloat($('#currentPrice').text().replace('$', '').replace(',', ''))
        };
        
        openPositions.push(order);
        updatePositions();
        
        showTradingAlert(`${type.toUpperCase()} order placed successfully`, 'success');
        showLoading(false);
        
        if (tradingSettings.soundAlerts) {
            // Play sound alert
            playOrderSound();
        }
    }, 1000);
}

// Update positions display
function updatePositions() {
    if (openPositions.length === 0) {
        $('#openPositions').html(`
            <div class="text-center text-muted py-4">
                <i class="fas fa-box-open fa-2x mb-2"></i>
                <p>No open positions</p>
            </div>
        `);
        return;
    }
    
    const html = openPositions.map(position => {
        const currentPrice = parseFloat($('#currentPrice').text().replace('$', '').replace(',', '')) || position.openPrice;
        const pnl = position.type === 'buy' 
            ? (currentPrice - position.openPrice) * position.volume * 100
            : (position.openPrice - currentPrice) * position.volume * 100;
        
        return `
            <div class="position-item ${position.type === 'sell' ? 'sell' : ''}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-bold">${position.symbol}</div>
                        <small class="text-muted">${position.type.toUpperCase()}  ${position.volume}  ${position.leverage}x</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold ${pnl >= 0 ? 'text-success' : 'text-danger'}">
                            ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}
                        </div>
                        <small class="text-muted">SL: ${position.stopLoss} | TP: ${position.takeProfit}</small>
                    </div>
                </div>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-light me-1" onclick="closePosition(${position.id})">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="modifyPosition(${position.id})">
                        <i class="fas fa-edit"></i> Modify
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    $('#openPositions').html(html);
}

// Close position
function closePosition(positionId) {
    const position = openPositions.find(p => p.id === positionId);
    if (!position) return;
    
    if (confirm(`Close ${position.symbol} ${position.type} position?`)) {
        const currentPrice = parseFloat($('#currentPrice').text().replace('$', '').replace(',', '')) || position.openPrice;
        const pnl = position.type === 'buy' 
            ? (currentPrice - position.openPrice) * position.volume * 100
            : (position.openPrice - currentPrice) * position.volume * 100;
        
        openPositions = openPositions.filter(p => p.id !== positionId);
        updatePositions();
        
        showTradingAlert(`Position closed. P&L: $${pnl.toFixed(2)}`, 'info');
    }
}

// Show trading settings modal
function showTradingSettings() {
    $('#maxRisk').val(tradingSettings.maxRisk);
    $('#maxRiskValue').text(tradingSettings.maxRisk + '%');
    $('#dailyLossLimit').val(tradingSettings.dailyLossLimit);
    $('#soundAlerts').prop('checked', tradingSettings.soundAlerts);
    $('#confirmOrders').prop('checked', tradingSettings.confirmOrders);
    $('#oneClickTrading').prop('checked', tradingSettings.oneClickTrading);
    
    $('#tradingSettingsModal').modal('show');
}

// Save trading settings
function saveTradingSettings() {
    tradingSettings = {
        maxRisk: parseInt($('#maxRisk').val()),
        dailyLossLimit: parseFloat($('#dailyLossLimit').val()),
        soundAlerts: $('#soundAlerts').is(':checked'),
        confirmOrders: $('#confirmOrders').is(':checked'),
        oneClickTrading: $('#oneClickTrading').is(':checked')
    };
    
    $('#tradingSettingsModal').modal('hide');
    showToast('Trading settings saved successfully', 'success');
}

// Investment plan selection
function selectPlan(planId) {
    $('.investment-plan').removeClass('selected');
    $(`.investment-plan[data-plan="${planId}"]`).addClass('selected');
    
    selectedPlan = planId;
    $('#selectedPlanId').val(planId);
    
    const plans = {
        1: { name: 'Basic Plan', rate: 5, min: 50, max: 1000 },
        2: { name: 'Premium Plan', rate: 8, min: 1001, max: 5000 },
        3: { name: 'VIP Plan', rate: 12, min: 5001, max: 20000 }
    };
    
    const plan = plans[planId];
    $('#selectedPlanName').val(plan.name);
    $('#profitRate').text(plan.rate);
    
    $('#investmentAmount').attr('min', plan.min);
    $('#investmentAmount').attr('max', plan.max);
    $('#investmentAmount').val('');
    
    $('#investButton').prop('disabled', true);
    calculateExpectedProfit();
}

// Calculate expected profit
function calculateExpectedProfit() {
    if (!selectedPlan) return;
    
    const amount = parseFloat($('#investmentAmount').val()) || 0;
    const plans = { 1: 5, 2: 8, 3: 12 };
    const rate = plans[selectedPlan];
    
    const profit = (amount * rate / 100).toFixed(2);
    $('#expectedProfit').text(profit);
    
    // Enable/disable invest button based on amount validation
    const planLimits = {
        1: { min: 50, max: 1000 },
        2: { min: 1001, max: 5000 },
        3: { min: 5001, max: 20000 }
    };
    
    const limits = planLimits[selectedPlan];
    const isValid = amount >= limits.min && amount <= limits.max && amount <= currentUser.depositBalance;
    
    $('#investButton').prop('disabled', !isValid);
}

// Submit investment
function submitInvestment() {
    const amount = parseFloat($('#investmentAmount').val());
    const planId = selectedPlan;
    
    if (!amount || !planId) {
        showToast('Please select a plan and enter amount', 'warning');
        return;
    }
    
    if (amount > currentUser.depositBalance) {
        showToast('Insufficient deposit balance', 'danger');
        return;
    }
    
    showLoading(true);
    
    // Simulate API call
    setTimeout(() => {
        currentUser.depositBalance -= amount;
        currentUser.totalInvested += amount;
        
        updateUserInterface();
        loadDashboardData();
        
        $('#investmentModal').modal('hide');
        showToast('Investment created successfully', 'success');
        showLoading(false);
    }, 1500);
}

// Submit deposit
function submitDeposit() {
    const formData = new FormData($('#depositForm')[0]);
    const amount = parseFloat(formData.get('amount'));
    
    if (!amount || amount < 10) {
        showToast('Minimum deposit is $10', 'warning');
        return;
    }
    
    showLoading(true);
    
    // Simulate deposit processing
    setTimeout(() => {
        currentUser.depositBalance += amount;
        updateUserInterface();
        
        $('#depositModal').modal('hide');
        $('#depositForm')[0].reset();
        showToast('Deposit submitted for processing', 'success');
        showLoading(false);
    }, 1500);
}

// Update profile
function updateProfile() {
    const name = $('#profileName').val();
    const bitcoinAccount = $('#profileBitcoin').val();
    const tetherAccount = $('#profileTether').val();
    const secretQuestion = $('#profileQuestion').val();
    const secretAnswer = $('#profileAnswer').val();
    
    if (!name || !secretQuestion || !secretAnswer) {
        showToast('Please fill all required fields', 'warning');
        return;
    }
    
    currentUser.name = name;
    currentUser.bitcoinAccount = bitcoinAccount;
    currentUser.tetherTRC20Account = tetherAccount;
    currentUser.secretQuestion = secretQuestion;
    
    localStorage.setItem('userData', JSON.stringify(currentUser));
    updateUserInterface();
    
    $('#profileModal').modal('hide');
    showToast('Profile updated successfully', 'success');
}

// Show profile modal
function showProfileModal() {
    $('#profileModal').modal('show');
}

// Show referrals modal
function showReferralsModal() {
    loadReferralsData();
    $('#referralsModal').modal('show');
}

// Load referrals data
function loadReferralsData() {
    $('#totalReferrals').text(Math.floor(Math.random() * 15));
    
    // Simulate referrals list
    const referrals = [
        { username: 'john_smith', email: 'john.smith@example.com', joined: '2024-01-15', invested: 2500 },
        { username: 'sara_jones', email: 'sara.jones@example.com', joined: '2024-01-20', invested: 1500 },
        { username: 'mike_wilson', email: 'mike.wilson@example.com', joined: '2024-01-25', invested: 5000 }
    ];
    
    const html = referrals.map(ref => `
        <tr>
            <td>${ref.username}</td>
            <td>${ref.email}</td>
            <td>${ref.joined}</td>
            <td>$${ref.invested.toLocaleString()}</td>
        </tr>
    `).join('');
    
    $('#referralsList').html(html);
}

// Copy referral code
function copyReferralCode() {
    const code = $('#referralCode').val();
    navigator.clipboard.writeText(code).then(() => {
        showToast('Referral code copied to clipboard', 'success');
    });
}

// Copy referral link
function copyReferralLink() {
    const link = $('#referralLink').val();
    navigator.clipboard.writeText(link).then(() => {
        showToast('Referral link copied to clipboard', 'success');
    });
}

// Show loading spinner
function showLoading(show) {
    if (show) {
        $('#loadingSpinner').fadeIn();
    } else {
        $('#loadingSpinner').fadeOut();
    }
}

// Show trading alert
function showTradingAlert(message, type) {
    const alert = $('#tradingAlert');
    alert.removeClass('alert-success alert-danger alert-warning alert-info')
          .addClass(`alert-${type}`)
          .text(message)
          .fadeIn();
    
    setTimeout(() => {
        alert.fadeOut();
    }, 5000);
}

// Show toast notification
function showToast(message, type) {
    const toastId = 'toast-' + Date.now();
    const toast = $(`
        <div class="toast align-items-center text-white bg-${type} border-0" id="${toastId}">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `);
    
    $('#toastContainer').append(toast);
    const bsToast = new bootstrap.Toast(toast[0]);
    bsToast.show();
    
    toast.on('hidden.bs.toast', function() {
        $(this).remove();
    });
}

// Play order sound
function playOrderSound() {
    // In a real app, you would play a sound file
    console.log('Playing order sound');
}

// Logout
function logout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('userData');
        window.location.href = 'login.html';
    }
}

// Utility functions
function filterInstruments() {
    const searchTerm = $('#instrumentSearch').val().toLowerCase();
    $('.instrument-item').each(function() {
        const symbol = $(this).data('symbol').toLowerCase();
        const name = $(this).find('small').text().toLowerCase();
        const matches = symbol.includes(searchTerm) || name.includes(searchTerm);
        $(this).toggle(matches);
    });
}

function viewInvestmentDetails(amount) {
    showToast(`Investment details for $${amount.toLocaleString()}`, 'info');
}

function addIndicator(indicator) {
    showToast(`${indicator} indicator added to chart`, 'info');
}

function activateTool(tool) {
    showToast(`${tool} drawing tool activated`, 'info');
}

function clearDrawings() {
    showToast('All drawings cleared', 'info');
}

function modifyPosition(positionId) {
    showToast('Modify position functionality would open here', 'info');
}

function loadSectionContent(section) {
    // This would load content for other sections dynamically
    $('#otherSections').html(`
        <div class="container-fluid py-4">
            <div class="row">
                <div class="col-12">
                    <div class="chart-container text-center">
                        <h3>${$('#pageTitle').text()}</h3>
                        <p class="text-muted">This section is under development</p>
                        <i class="fas fa-tools fa-3x text-primary mt-3"></i>
                    </div>
                </div>
            </div>
        </div>
    `);
}

// Update max risk value display
$('#maxRisk').on('input', function() {
    $('#maxRiskValue').text($(this).val() + '%');
});

// Initialize the application
$(document).ready(function() {
    console.log('Galaxy Digital Trading Platform initialized');
});


</script>

</body>
</html>