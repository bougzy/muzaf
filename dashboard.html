<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Digital Holdings - Professional Trading Platform</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- TradingView Widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --dark-color: #34495e;
            --light-color: #ecf0f1;
            --buy-color: #00c853;
            --sell-color: #ff4444;
            --profit-color: #00c853;
            --loss-color: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: white;
            min-height: 100vh;
            box-shadow: 3px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            width: 250px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar.collapsed .nav-link span,
        .sidebar.collapsed .brand-text,
        .sidebar.collapsed .quick-stats {
            display: none;
        }

        .sidebar.collapsed .nav-link {
            text-align: center;
            padding: 12px 5px;
        }

        .sidebar.collapsed .nav-link i {
            margin-right: 0;
        }

        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 5px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }

        .sidebar .nav-link i {
            width: 20px;
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .brand-container {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 10px;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .brand-text {
            margin-left: 10px;
        }

        .toggle-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 20px;
        }

        /* Quick Stats in Sidebar */
        .quick-stats {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            text-align: center;
        }

        .quick-stats small {
            color: rgba(255,255,255,0.7);
            display: block;
            margin-bottom: 5px;
        }

        .quick-stats .fw-bold {
            font-size: 1.1rem;
        }

        /* Main Content Area */
        .main-content {
            margin-left: 250px;
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        .main-content.expanded {
            margin-left: 70px;
        }

        /* Navigation Bar */
        .top-navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px 20px;
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .nav-user-info {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }

        /* Notification Styles */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-item {
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .notification-item.unread {
            background-color: #e3f2fd;
            border-left-color: var(--accent-color);
        }

        .notification-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Card Styles */
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .stat-card .card-title {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-card .card-change {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .bg-wallet { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
        }
        .bg-deposit { 
            background: linear-gradient(45deg, #f093fb, #f5576c); 
            color: white; 
        }
        .bg-investment { 
            background: linear-gradient(45deg, #4facfe, #00f2fe); 
            color: white; 
        }
        .bg-profit { 
            background: linear-gradient(45deg, #43e97b, #38f9d7); 
            color: white; 
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .table-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: none;
            overflow: hidden;
        }

        .table-card .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 15px 20px;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            color: var(--primary-color);
            background-color: #f8f9fa;
            padding: 15px;
        }

        .table td {
            padding: 15px;
            vertical-align: middle;
        }

        /* Badge Styles */
        .badge-success { 
            background-color: var(--success-color); 
            color: white;
        }
        .badge-warning { 
            background-color: var(--warning-color); 
            color: white;
        }
        .badge-danger { 
            background-color: var(--accent-color); 
            color: white;
        }
        .badge-info { 
            background-color: var(--info-color); 
            color: white;
        }
        .badge-primary { 
            background-color: var(--secondary-color); 
            color: white;
        }

        /* Button Styles */
        .btn-primary {
            background: linear-gradient(45deg, var(--secondary-color), #2980b9);
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success-color), #219a52);
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, var(--warning-color), #e67e22);
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--accent-color), #c0392b);
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-outline-primary {
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
            background: transparent;
            border-radius: 8px;
            padding: 8px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            background: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
        }

        /* Modal Styles */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-header {
            border-bottom: 1px solid #e9ecef;
            padding: 20px 25px;
        }

        .modal-footer {
            border-top: 1px solid #e9ecef;
            padding: 20px 25px;
        }

        /* Investment Plan Styles */
        .investment-plan {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .investment-plan:hover {
            border-color: var(--secondary-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .investment-plan.selected {
            border-color: var(--secondary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }

        .plan-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .plan-rate {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--success-color);
            margin: 15px 0;
        }

        .plan-features {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .plan-features li {
            padding: 5px 0;
            color: #6c757d;
        }

        /* Trading Room Styles */
        .trading-room {
            background: #1e1e1e;
            color: white;
            min-height: calc(100vh - 80px);
        }

        .trading-header {
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            padding: 15px 20px;
        }

        .trading-chart {
            height: 500px;
            background: #131722;
            border: 1px solid #2a2e39;
        }

        .trading-panel {
            background: #2d2d2d;
            border-left: 1px solid #404040;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .order-form {
            background: #2d2d2d;
            padding: 20px;
            border-bottom: 1px solid #404040;
        }

        .market-data {
            background: #2d2d2d;
            padding: 15px;
        }

        .position-item {
            background: #363636;
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid var(--success-color);
            transition: all 0.3s ease;
        }

        .position-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .position-item.sell {
            border-left-color: var(--sell-color);
        }

        .order-book {
            background: #2d2d2d;
            padding: 15px;
        }

        .bid-row {
            background: rgba(0, 200, 83, 0.1);
            padding: 5px 10px;
            margin: 2px 0;
            border-radius: 3px;
        }

        .ask-row {
            background: rgba(255, 68, 68, 0.1);
            padding: 5px 10px;
            margin: 2px 0;
            border-radius: 3px;
        }

        .btn-buy {
            background: var(--buy-color);
            border: none;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-buy:hover {
            background: #00b34a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 200, 83, 0.4);
        }

        .btn-sell {
            background: var(--sell-color);
            border: none;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-sell:hover {
            background: #e63c3c;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 68, 68, 0.4);
        }

        .trading-tabs .nav-link {
            color: #ccc;
            border: none;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }

        .trading-tabs .nav-link.active {
            background: #363636;
            color: white;
            border-bottom: 2px solid var(--secondary-color);
        }

        .instrument-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .instrument-item {
            padding: 10px;
            border-bottom: 1px solid #404040;
            cursor: pointer;
            transition: background 0.3s;
        }

        .instrument-item:hover {
            background: #363636;
        }

        .instrument-item.active {
            background: var(--secondary-color);
        }

        .price-up {
            color: var(--buy-color);
        }

        .price-down {
            color: var(--sell-color);
        }

        .indicator-settings {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .timeframe-selector {
            display: flex;
            gap: 5px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .timeframe-btn {
            padding: 5px 10px;
            border: 1px solid #404040;
            background: #2d2d2d;
            color: #ccc;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timeframe-btn.active {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .timeframe-btn:hover:not(.active) {
            background: #363636;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* WebSocket Status */
        .websocket-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .websocket-connected {
            background-color: var(--success-color);
            color: white;
        }

        .websocket-disconnected {
            background-color: var(--accent-color);
            color: white;
        }

        /* Trading specific styles */
        .leverage-slider {
            width: 100%;
            margin: 10px 0;
        }

        .risk-indicator {
            height: 5px;
            background: #404040;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .risk-level {
            height: 100%;
            background: var(--success-color);
            transition: width 0.3s;
        }

        .trading-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }

        .toast {
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar .nav-link span,
            .sidebar .brand-text,
            .sidebar .quick-stats {
                display: none;
            }
            
            .sidebar .nav-link {
                text-align: center;
                padding: 12px 5px;
            }
            
            .sidebar .nav-link i {
                margin-right: 0;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .stat-card .card-value {
                font-size: 1.5rem;
            }
            
            .trading-panel {
                height: auto;
                border-left: none;
                border-top: 1px solid #404040;
            }
        }

        @media (max-width: 576px) {
            .timeframe-selector {
                justify-content: center;
            }
            
            .btn-buy, .btn-sell {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .investment-plan {
                padding: 15px;
            }
            
            .plan-rate {
                font-size: 2rem;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }

        .trading-panel::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .trading-panel::-webkit-scrollbar-thumb {
            background: #555;
        }

        .trading-panel::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Utility Classes */
        .text-profit {
            color: var(--profit-color);
        }

        .text-loss {
            color: var(--loss-color);
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .border-radius-10 {
            border-radius: 10px;
        }

        .shadow-custom {
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .hover-lift:hover {
            transform: translateY(-3px);
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="brand-container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-globe-americas"></i>
                <span class="brand-text">Galaxy Digital</span>
            </a>
            <button class="toggle-sidebar" id="toggleSidebar">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="trading">
                    <i class="fas fa-chart-bar"></i>
                    <span>Trading Room</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="deposit">
                    <i class="fas fa-wallet"></i>
                    <span>Deposit Funds</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="invest">
                    <i class="fas fa-chart-line"></i>
                    <span>Invest</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="transactions">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Transactions</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="earnings">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Earnings</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="reports">
                    <i class="fas fa-file-alt"></i>
                    <span>Reports</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
        </ul>

        <div class="quick-stats">
            <small class="text-white-50">QUICK STATS</small>
            <div class="row mt-2 text-white">
                <div class="col-6">
                    <small>This Week</small>
                    <div class="fw-bold" id="quickWeekEarnings">$0</div>
                </div>
                <div class="col-6">
                    <small>Referrals</small>
                    <div class="fw-bold" id="quickReferrals">0</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Navigation Bar -->
        <nav class="top-navbar">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div>
                        <h4 class="mb-0" id="pageTitle">Dashboard</h4>
                    </div>
                    
                    <div class="d-flex align-items-center">
                        <!-- Notifications -->
                        <div class="dropdown me-3">
                            <a href="#" class="text-dark position-relative" id="notificationDropdown" data-bs-toggle="dropdown">
                                <i class="fas fa-bell fa-lg"></i>
                                <span class="notification-badge" id="notificationCount">0</span>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end p-3" style="width: 350px;">
                                <h6 class="dropdown-header">Notifications</h6>
                                <div id="notificationList">
                                    <!-- Notifications will be loaded here -->
                                </div>
                                <div class="text-center mt-2">
                                    <a href="#" class="text-decoration-none" onclick="loadNotifications()">View All</a>
                                </div>
                            </div>
                        </div>

                        <!-- User Menu -->
                        <div class="dropdown">
                            <a href="#" class="text-dark text-decoration-none dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown">
                                <div class="user-avatar" id="userAvatar">JD</div>
                                <span id="userName">Loading...</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="showProfileModal()"><i class="fas fa-user me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showReferralsModal()"><i class="fas fa-users me-2"></i>Referrals</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="container-fluid py-4">
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card bg-wallet text-white">
                        <i class="fas fa-wallet"></i>
                        <div class="card-title">Wallet Balance</div>
                        <div class="card-value" id="walletBalance">$0.00</div>
                        <div class="card-change">
                            <i class="fas fa-arrow-up me-1"></i>
                            <span id="walletChange">0%</span> from last week
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card bg-deposit text-white">
                        <i class="fas fa-piggy-bank"></i>
                        <div class="card-title">Deposit Balance</div>
                        <div class="card-value" id="depositBalance">$0.00</div>
                        <div class="card-change">
                            <i class="fas fa-arrow-up me-1"></i>
                            <span id="depositChange">0%</span> available for investment
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card bg-investment text-white">
                        <i class="fas fa-chart-line"></i>
                        <div class="card-title">Total Invested</div>
                        <div class="card-value" id="totalInvested">$0.00</div>
                        <div class="card-change">
                            <i class="fas fa-arrow-up me-1"></i>
                            <span id="investmentChange">0%</span> active investments
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card bg-profit text-white">
                        <i class="fas fa-money-bill-wave"></i>
                        <div class="card-title">Total Profit</div>
                        <div class="card-value" id="totalProfit">$0.00</div>
                        <div class="card-change">
                            <i class="fas fa-arrow-up me-1"></i>
                            <span id="profitChange">0%</span> this month
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Recent Activity -->
            <div class="row">
                <!-- Earnings Chart -->
                <div class="col-lg-8 mb-4">
                    <div class="chart-container">
                        <h5 class="mb-4">Earnings Overview</h5>
                        <canvas id="earningsChart" height="250"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="col-lg-4 mb-4">
                    <div class="chart-container">
                        <h5 class="mb-4">Recent Activity</h5>
                        <div id="recentActivity">
                            <!-- Activity items will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container">
                        <h5 class="mb-4">Quick Actions</h5>
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-primary w-100 py-3" onclick="showDepositModal()">
                                    <i class="fas fa-plus-circle fa-2x mb-2"></i><br>
                                    Deposit Funds
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-success w-100 py-3" onclick="showInvestmentModal()">
                                    <i class="fas fa-chart-line fa-2x mb-2"></i><br>
                                    New Investment
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-info w-100 py-3" onclick="showSection('transactions')">
                                    <i class="fas fa-history fa-2x mb-2"></i><br>
                                    View Transactions
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-warning w-100 py-3" onclick="showReferralsModal()">
                                    <i class="fas fa-users fa-2x mb-2"></i><br>
                                    Refer Friends
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Investments -->
            <div class="row">
                <div class="col-12">
                    <div class="table-card">
                        <div class="card-header bg-transparent">
                            <h5 class="mb-0">Active Investments</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Plan</th>
                                            <th>Amount</th>
                                            <th>Profit Rate</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="investmentsTable">
                                        <!-- Investments will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Room Section -->
        <div id="tradingSection" style="display: none;">
            <div class="trading-room">
                <!-- Trading Header -->
                <div class="trading-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h4 class="mb-0 me-4">Trading Room</h4>
                        <div class="timeframe-selector">
                            <button class="timeframe-btn active" data-timeframe="1">1m</button>
                            <button class="timeframe-btn" data-timeframe="5">5m</button>
                            <button class="timeframe-btn" data-timeframe="15">15m</button>
                            <button class="timeframe-btn" data-timeframe="30">30m</button>
                            <button class="timeframe-btn" data-timeframe="60">1h</button>
                            <button class="timeframe-btn" data-timeframe="240">4h</button>
                            <button class="timeframe-btn" data-timeframe="D">1D</button>
                            <button class="timeframe-btn" data-timeframe="W">1W</button>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <span class="text-muted">Balance: </span>
                            <span class="fw-bold text-success" id="tradingBalance">$0.00</span>
                        </div>
                        <div class="me-3">
                            <span class="text-muted">Free Margin: </span>
                            <span class="fw-bold text-info" id="freeMargin">$0.00</span>
                        </div>
                        <button class="btn btn-sm btn-outline-light" onclick="showTradingSettings()">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>

                <div class="row g-0">
                    <!-- Left Panel - Chart -->
                    <div class="col-lg-8 col-xl-9">
                        <!-- Chart Container -->
                        <div class="trading-chart" id="tradingChart"></div>
                        
                        <!-- Trading Tools -->
                        <div class="bg-dark p-3 border-top border-secondary">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-light mb-3">Technical Indicators</h6>
                                    <div class="row g-2">
                                        <div class="col-4">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="addIndicator('MACD')">MACD</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="addIndicator('RSI')">RSI</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="addIndicator('BB')">Bollinger</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="addIndicator('SMA')">SMA</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="addIndicator('EMA')">EMA</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="addIndicator('Stoch')">Stochastic</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-light mb-3">Drawing Tools</h6>
                                    <div class="row g-2">
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('line')" title="Line">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('ray')" title="Ray">
                                                <i class="fas fa-long-arrow-alt-right"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('horizontal')" title="Horizontal Line">
                                                <i class="fas fa-arrows-alt-h"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('vertical')" title="Vertical Line">
                                                <i class="fas fa-arrows-alt-v"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('rectangle')" title="Rectangle">
                                                <i class="fas fa-square"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('circle')" title="Circle">
                                                <i class="fas fa-circle"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-light w-100" onclick="activateTool('fibonacci')" title="Fibonacci">
                                                <i class="fas fa-wave-square"></i>
                                            </button>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-sm btn-outline-danger w-100" onclick="clearDrawings()" title="Clear All">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - Trading Tools -->
                    <div class="col-lg-4 col-xl-3 trading-panel">
                        <!-- Instrument Selection -->
                        <div class="market-data">
                            <h6 class="text-light mb-3">Markets</h6>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control bg-dark text-light border-secondary" 
                                       placeholder="Search instruments..." id="instrumentSearch">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="instrument-list">
                                <!-- Instruments will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Order Form -->
                        <div class="order-form">
                            <h6 class="text-light mb-3">Quick Trade</h6>
                            <div class="mb-3">
                                <label class="form-label text-light">Instrument</label>
                                <select class="form-select bg-dark text-light border-secondary" id="tradeSymbol">
                                    <option value="BTCUSD">BTC/USD</option>
                                    <option value="ETHUSD">ETH/USD</option>
                                    <option value="XRPUSD">XRP/USD</option>
                                    <option value="LTCUSD">LTC/USD</option>
                                    <option value="ADAUSD">ADA/USD</option>
                                </select>
                            </div>
                            
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="form-label text-light">Lots</label>
                                    <input type="number" class="form-control bg-dark text-light border-secondary" 
                                           id="tradeVolume" value="0.01" min="0.01" step="0.01">
                                </div>
                                <div class="col-6">
                                    <label class="form-label text-light">Leverage</label>
                                    <select class="form-select bg-dark text-light border-secondary" id="tradeLeverage">
                                        <option value="1">1:1</option>
                                        <option value="5">1:5</option>
                                        <option value="10">1:10</option>
                                        <option value="25">1:25</option>
                                        <option value="50">1:50</option>
                                        <option value="100">1:100</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-light">Take Profit</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" 
                                       id="takeProfit" placeholder="Auto calculate">
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-light">Stop Loss</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" 
                                       id="stopLoss" placeholder="Auto calculate">
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-light">Risk Management</label>
                                <div class="risk-indicator">
                                    <div class="risk-level" id="riskLevel" style="width: 30%;"></div>
                                </div>
                                <small class="text-muted" id="riskPercentage">30% of balance at risk</small>
                            </div>

                            <div class="row g-2">
                                <div class="col-6">
                                    <button class="btn btn-buy w-100 py-3" onclick="placeOrder('buy')">
                                        <i class="fas fa-arrow-up me-2"></i>BUY
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-sell w-100 py-3" onclick="placeOrder('sell')">
                                        <i class="fas fa-arrow-down me-2"></i>SELL
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Positions -->
                        <div class="market-data">
                            <h6 class="text-light mb-3">Open Positions</h6>
                            <div id="openPositions">
                                <!-- Positions will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Order Book -->
                        <div class="order-book">
                            <h6 class="text-light mb-3">Order Book</h6>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between text-light">
                                    <span>Price</span>
                                    <span>Size</span>
                                </div>
                            </div>
                            <div id="orderBookBids">
                                <!-- Bids will be populated by JavaScript -->
                            </div>
                            <div class="text-center my-2">
                                <span class="text-warning fw-bold" id="currentPrice">$0.00</span>
                            </div>
                            <div id="orderBookAsks">
                                <!-- Asks will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Other Sections (Deposit, Invest, Transactions, etc.) -->
        <div id="otherSections" style="display: none;"></div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading...</p>
        </div>
    </div>

    <!-- Trading Alerts -->
    <div class="trading-alert" id="tradingAlert" style="display: none;"></div>

    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Trading Settings Modal -->
    <div class="modal fade" id="tradingSettingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Trading Settings</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Risk Management</h6>
                            <div class="mb-3">
                                <label class="form-label">Max Risk Per Trade (%)</label>
                                <input type="range" class="form-range" id="maxRisk" min="1" max="100" value="5">
                                <div class="d-flex justify-content-between">
                                    <small>1%</small>
                                    <small id="maxRiskValue">5%</small>
                                    <small>100%</small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Daily Loss Limit ($)</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" 
                                       id="dailyLossLimit" value="1000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Trading Preferences</h6>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="soundAlerts" checked>
                                    <label class="form-check-label" for="soundAlerts">
                                        Sound Alerts
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="confirmOrders" checked>
                                    <label class="form-check-label" for="confirmOrders">
                                        Confirm Orders
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="oneClickTrading">
                                    <label class="form-check-label" for="oneClickTrading">
                                        One-Click Trading
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTradingSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal fade" id="depositModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Deposit Funds</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="depositForm" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Amount (USD)</label>
                                <input type="number" class="form-control" name="amount" required min="10">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Payment Method</label>
                                <select class="form-select" name="paymentMethod" required>
                                    <option value="bitcoin">Bitcoin</option>
                                    <option value="tether">USDT (TRC20)</option>
                                    <option value="bank">Bank Transfer</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Wallet Address</label>
                            <input type="text" class="form-control" name="walletAddress" required placeholder="Enter your wallet address">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Proof of Payment</label>
                            <input type="file" class="form-control" name="proof" accept="image/*,.pdf" required>
                            <small class="text-muted">Upload screenshot or PDF of transaction</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitDeposit()">Submit Deposit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Investment Modal -->
    <div class="modal fade" id="investmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Make Investment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="investmentForm">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="investment-plan" data-plan="1" onclick="selectPlan(1)">
                                    <div class="plan-name">Basic Plan</div>
                                    <div class="plan-rate">5%</div>
                                    <div class="text-muted">30 days</div>
                                    <small>$50 - $1,000</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="investment-plan" data-plan="2" onclick="selectPlan(2)">
                                    <div class="plan-name">Premium Plan</div>
                                    <div class="plan-rate">8%</div>
                                    <div class="text-muted">30 days</div>
                                    <small>$1,001 - $5,000</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="investment-plan" data-plan="3" onclick="selectPlan(3)">
                                    <div class="plan-name">VIP Plan</div>
                                    <div class="plan-rate">12%</div>
                                    <div class="text-muted">30 days</div>
                                    <small>$5,001 - $20,000</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Investment Amount</label>
                                <input type="number" class="form-control" name="amount" required id="investmentAmount">
                                <small class="text-muted">Available deposit: $<span id="availableDeposit">0</span></small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Selected Plan</label>
                                <input type="text" class="form-control" id="selectedPlanName" readonly>
                                <input type="hidden" name="planId" id="selectedPlanId">
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <strong>Expected Profit:</strong> $<span id="expectedProfit">0</span> 
                            (<span id="profitRate">0</span>% return)
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="submitInvestment()" id="investButton" disabled>
                        Confirm Investment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Profile Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="profileForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control" name="name" id="profileName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" value="" id="profileEmail" readonly>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Bitcoin Wallet</label>
                                <input type="text" class="form-control" name="bitcoinAccount" id="profileBitcoin">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">USDT (TRC20) Wallet</label>
                                <input type="text" class="form-control" name="tetherTRC20Account" id="profileTether">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Security Question</label>
                                <input type="text" class="form-control" name="secretQuestion" id="profileQuestion" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Security Answer</label>
                                <input type="password" class="form-control" name="secretAnswer" id="profileAnswer" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateProfile()">Update Profile</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Referrals Modal -->
    <div class="modal fade" id="referralsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Referral Program</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 id="totalReferrals">0</h3>
                                    <p class="text-muted">Total Referrals</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6>Your Referral Code</h6>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="referralCode" readonly>
                                        <button class="btn btn-outline-primary" onclick="copyReferralCode()">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Referral Link</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="referralLink" readonly>
                            <button class="btn btn-outline-primary" onclick="copyReferralLink()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Joined</th>
                                    <th>Invested</th>
                                </tr>
                            </thead>
                            <tbody id="referralsList">
                                <!-- Referrals will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WebSocket Status -->
    <div class="websocket-status" id="websocketStatus">
        <i class="fas fa-wifi me-1"></i>
        <span>Connecting...</span>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        const API_BASE_URL = 'https://muza-xi3w.onrender.com/api';
        let currentUser = null;
        let websocket = null;
        let earningsChart = null;
        let selectedPlan = null;
        let tradingChart = null;
        let currentInstrument = 'BTCUSD';
        let currentTimeframe = '1';
        let openPositions = [];
        let orderBook = { bids: [], asks: [] };
        let tradingSettings = {
            maxRisk: 5,
            dailyLossLimit: 1000,
            soundAlerts: true,
            confirmOrders: true,
            oneClickTrading: false
        };

        // Initialize dashboard when page loads
        $(document).ready(function() {
            checkAuthentication();
            initializeWebSocket();
            loadDashboardData();
            setupEventListeners();
            initializeTradingRoom();
        });

        // Authentication check
        function checkAuthentication() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'register.html';
                return;
            }
            
            // Load user data from API
            loadUserData();
        }

        // Load user data from API
        async function loadUserData() {
            try {
                showLoading(true);
                const response = await fetch(`${API_BASE_URL}/me`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch user data');
                }

                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.data.user;
                    updateUserInterface(currentUser);
                } else {
                    throw new Error(result.message || 'Failed to load user data');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Failed to load user data. Please try again.', 'danger');
                // If token is invalid, redirect to login
                if (error.message.includes('token') || error.message.includes('unauthorized')) {
                    logout();
                }
            } finally {
                showLoading(false);
            }
        }

        // Update UI with user data
        function updateUserInterface(user) {
            $('#userName').text(user.name || user.username || 'User');
            $('#userAvatar').text(user.name ? user.name.substring(0, 2).toUpperCase() : 'JD');
            $('#profileName').val(user.name || '');
            $('#profileEmail').val(user.email || '');
            $('#profileBitcoin').val(user.bitcoinAccount || '');
            $('#profileTether').val(user.tetherTRC20Account || '');
            $('#profileQuestion').val(user.secretQuestion || '');
            
            // Update balances
            $('#walletBalance').text(`$${(user.walletBalance || 0).toFixed(2)}`);
            $('#depositBalance').text(`$${(user.depositBalance || 0).toFixed(2)}`);
            $('#totalInvested').text(`$${(user.totalInvested || 0).toFixed(2)}`);
            $('#tradingBalance').text(`$${(user.walletBalance || 0).toFixed(2)}`);
            $('#availableDeposit').text((user.depositBalance || 0).toFixed(2));
            
            // Update referral code
            if (user.referralCode) {
                $('#referralCode').val(user.referralCode);
                $('#referralLink').val(`${window.location.origin}/register.html?ref=${user.referralCode}`);
            }
        }

        // Initialize WebSocket connection
        function initializeWebSocket() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                // Connect to WebSocket
                const wsUrl = API_BASE_URL.replace('https', 'wss').replace('http', 'ws') + '/ws';
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function() {
                    console.log('WebSocket connected');
                    updateWebSocketStatus(true);
                    
                    // Authenticate with token
                    websocket.send(JSON.stringify({
                        type: 'AUTH',
                        token: token
                    }));
                };
                
                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };
                
                websocket.onclose = function() {
                    console.log('WebSocket disconnected');
                    updateWebSocketStatus(false);
                    
                    // Attempt to reconnect after 5 seconds
                    setTimeout(initializeWebSocket, 5000);
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateWebSocketStatus(false);
                };
                
            } catch (error) {
                console.error('WebSocket connection failed:', error);
                updateWebSocketStatus(false);
            }
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'CONNECTED':
                    console.log('WebSocket authenticated successfully');
                    break;
                    
                case 'NEW_NOTIFICATION':
                    showToast(data.message, 'info');
                    loadNotifications();
                    break;
                    
                case 'DEPOSIT_APPROVED':
                    showToast(data.message, 'success');
                    updateUserBalances(data);
                    loadDashboardData();
                    break;
                    
                case 'INVESTMENT_APPROVED':
                    showToast(data.message, 'success');
                    updateUserBalances(data);
                    loadDashboardData();
                    break;
                    
                case 'PROFIT_ADDED':
                    showToast(data.message, 'success');
                    updateUserBalances(data);
                    loadDashboardData();
                    break;
                    
                case 'BALANCE_UPDATE':
                    showToast(data.message, 'info');
                    updateUserBalances(data);
                    break;
                    
                default:
                    console.log('Unknown WebSocket message:', data);
            }
        }

        function updateUserBalances(data) {
            if (data.walletBalance !== undefined) {
                $('#walletBalance').text(`$${data.walletBalance.toFixed(2)}`);
                $('#tradingBalance').text(`$${data.walletBalance.toFixed(2)}`);
            }
            if (data.depositBalance !== undefined) {
                $('#depositBalance').text(`$${data.depositBalance.toFixed(2)}`);
                $('#availableDeposit').text(data.depositBalance.toFixed(2));
            }
            if (data.totalInvested !== undefined) {
                $('#totalInvested').text(`$${data.totalInvested.toFixed(2)}`);
            }
        }

        function updateWebSocketStatus(connected) {
            const statusElement = $('#websocketStatus');
            if (connected) {
                statusElement.removeClass('websocket-disconnected').addClass('websocket-connected');
                statusElement.html('<i class="fas fa-wifi me-1"></i><span>Connected</span>');
            } else {
                statusElement.removeClass('websocket-connected').addClass('websocket-disconnected');
                statusElement.html('<i class="fas fa-wifi-slash me-1"></i><span>Disconnected</span>');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Sidebar toggle
            $('#toggleSidebar').click(function() {
                $('#sidebar').toggleClass('collapsed');
                $('#mainContent').toggleClass('expanded');
            });

            // Navigation links
            $('.sidebar .nav-link').click(function(e) {
                e.preventDefault();
                const section = $(this).data('section');
                showSection(section);
                
                // Update active state
                $('.sidebar .nav-link').removeClass('active');
                $(this).addClass('active');
            });

            // Timeframe selector
            $('.timeframe-btn').click(function() {
                $('.timeframe-btn').removeClass('active');
                $(this).addClass('active');
                currentTimeframe = $(this).data('timeframe');
                updateTradingChart();
            });

            // Auto-calculate levels
            $('#tradeVolume, #tradeLeverage').on('input', function() {
                calculateRisk();
                autoCalculateLevels();
            });

            // Investment amount calculation
            $('#investmentAmount').on('input', function() {
                calculateExpectedProfit();
            });
        }

        // Show specific section
        function showSection(section) {
            // Hide all sections
            $('#dashboardSection, #tradingSection, #otherSections').hide();
            
            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                trading: 'Trading Room',
                deposit: 'Deposit Funds',
                invest: 'Investment Plans',
                transactions: 'Transaction History',
                earnings: 'Earnings Report',
                reports: 'Analytics Reports',
                settings: 'Account Settings'
            };
            
            $('#pageTitle').text(titles[section] || 'Dashboard');
            
            // Show selected section
            if (section === 'dashboard') {
                $('#dashboardSection').show();
                loadDashboardData();
            } else if (section === 'trading') {
                $('#tradingSection').show();
                initializeTradingRoom();
            } else if (section === 'deposit') {
                showDepositModal();
            } else if (section === 'invest') {
                showInvestmentModal();
            } else if (section === 'transactions') {
                loadTransactionsSection();
            } else {
                $('#otherSections').show();
                loadSectionContent(section);
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            showLoading(true);
            
            try {
                // Load user investments
                const investmentsResponse = await fetch(`${API_BASE_URL}/user/investments`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (investmentsResponse.ok) {
                    const result = await investmentsResponse.json();
                    if (result.success) {
                        loadInvestments(result.data);
                    }
                }

                // Load transactions
                const transactionsResponse = await fetch(`${API_BASE_URL}/user/transactions`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (transactionsResponse.ok) {
                    const result = await transactionsResponse.json();
                    if (result.success) {
                        loadRecentActivity(result.data);
                    }
                }

                // Load notifications
                loadNotifications();

                // Initialize earnings chart
                initializeEarningsChart();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Failed to load dashboard data', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Initialize earnings chart
        function initializeEarningsChart() {
            const ctx = document.getElementById('earningsChart').getContext('2d');
            
            if (earningsChart) {
                earningsChart.destroy();
            }
            
            earningsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Earnings ($)',
                        data: [120, 190, 300, 500, 200, 300, 450, 600, 550, 700, 800, 900],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Load recent activity
        function loadRecentActivity(transactions) {
            if (!transactions || !Array.isArray(transactions)) return;
            
            const recentTransactions = transactions.slice(0, 5);
            let html = '';
            
            recentTransactions.forEach(transaction => {
                const icons = {
                    deposit: 'fa-arrow-down text-success',
                    withdrawal: 'fa-arrow-up text-danger',
                    investment: 'fa-chart-line text-primary',
                    profit: 'fa-dollar-sign text-success',
                    admin_adjustment: 'fa-cog text-warning'
                };
                
                const statusClass = transaction.status === 'approved' ? 'badge-success' : 
                                  transaction.status === 'pending' ? 'badge-warning' : 'badge-danger';
                
                html += `
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <i class="fas ${icons[transaction.type] || 'fa-exchange'} fa-lg"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="d-flex justify-content-between">
                                <h6 class="mb-0">${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}</h6>
                                <span class="fw-bold">$${transaction.amount}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">${new Date(transaction.createdAt).toLocaleDateString()}</small>
                                <span class="badge ${statusClass}">${transaction.status}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            $('#recentActivity').html(html || '<p class="text-muted">No recent activity</p>');
        }

        // Load investments
        function loadInvestments(investments) {
            if (!investments || !Array.isArray(investments)) {
                $('#investmentsTable').html('<tr><td colspan="7" class="text-center text-muted">No active investments</td></tr>');
                return;
            }
            
            const activeInvestments = investments.filter(inv => inv.status === 'active');
            
            if (activeInvestments.length === 0) {
                $('#investmentsTable').html('<tr><td colspan="7" class="text-center text-muted">No active investments</td></tr>');
                return;
            }
            
            let html = '';
            activeInvestments.forEach(investment => {
                const statusClass = investment.status === 'active' ? 'badge-success' : 'badge-secondary';
                
                html += `
                    <tr>
                        <td>${investment.planName}</td>
                        <td>$${investment.amount}</td>
                        <td>${investment.profitRate}%</td>
                        <td>${new Date(investment.startDate).toLocaleDateString()}</td>
                        <td>${investment.endDate ? new Date(investment.endDate).toLocaleDateString() : 'N/A'}</td>
                        <td><span class="badge ${statusClass}">${investment.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary">View</button>
                        </td>
                    </tr>
                `;
            });
            
            $('#investmentsTable').html(html);
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const response = await fetch(`${API_BASE_URL}/user/notifications`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        displayNotifications(result.data.notifications);
                        $('#notificationCount').text(result.data.unreadCount || 0);
                    }
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function displayNotifications(notifications) {
            if (!notifications || !Array.isArray(notifications)) {
                $('#notificationList').html('<p class="text-muted text-center">No notifications</p>');
                return;
            }
            
            const recentNotifications = notifications.slice(0, 5);
            let html = '';
            
            recentNotifications.forEach(notification => {
                html += `
                    <div class="notification-item ${!notification.isRead ? 'unread' : ''}">
                        <h6 class="mb-1">${notification.title}</h6>
                        <p class="mb-1 small">${notification.content}</p>
                        <small class="text-muted">${new Date(notification.createdAt).toLocaleDateString()}</small>
                    </div>
                `;
            });
            
            $('#notificationList').html(html || '<p class="text-muted text-center">No notifications</p>');
        }

        // Initialize trading room
        function initializeTradingRoom() {
            loadInstruments();
            initializeTradingChart();
            updateTradingBalance();
            simulateOrderBook();
            startPriceUpdates();
        }

        // Load trading instruments
        function loadInstruments() {
            const instruments = [
                { symbol: 'BTCUSD', name: 'Bitcoin/USD', price: 43250.75, change: 2.5 },
                { symbol: 'ETHUSD', name: 'Ethereum/USD', price: 2580.25, change: -1.2 },
                { symbol: 'XRPUSD', name: 'Ripple/USD', price: 0.5789, change: 0.8 },
                { symbol: 'LTCUSD', name: 'Litecoin/USD', price: 72.45, change: -0.5 },
                { symbol: 'ADAUSD', name: 'Cardano/USD', price: 0.5234, change: 3.1 }
            ];
            
            let html = '';
            instruments.forEach(instrument => {
                const changeClass = instrument.change >= 0 ? 'price-up' : 'price-down';
                const changeIcon = instrument.change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                
                html += `
                    <div class="instrument-item ${instrument.symbol === currentInstrument ? 'active' : ''}" 
                         data-symbol="${instrument.symbol}" onclick="selectInstrument('${instrument.symbol}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold text-light">${instrument.symbol}</div>
                                <small class="text-muted">${instrument.name}</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-light">$${instrument.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 5})}</div>
                                <small class="${changeClass}">
                                    <i class="fas ${changeIcon} me-1"></i>
                                    ${instrument.change >= 0 ? '+' : ''}${instrument.change}%
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            $('.instrument-list').html(html);
        }

        // Select trading instrument
        function selectInstrument(symbol) {
            currentInstrument = symbol;
            $('.instrument-item').removeClass('active');
            $(`.instrument-item[data-symbol="${symbol}"]`).addClass('active');
            $('#tradeSymbol').val(symbol);
            updateTradingChart();
        }

        // Initialize TradingView chart
        function initializeTradingChart() {
            if (typeof TradingView !== 'undefined') {
                new TradingView.widget({
                    "autosize": true,
                    "symbol": "BINANCE:BTCUSDT",
                    "interval": "1",
                    "timezone": "Etc/UTC",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "hide_top_toolbar": true,
                    "hide_legend": true,
                    "save_image": false,
                    "container_id": "tradingChart",
                    "studies": [
                        "RSI@tv-basicstudies"
                    ]
                });
            }
        }

        // Update trading chart when timeframe changes
        function updateTradingChart() {
            // In a real implementation, this would update the TradingView chart
            console.log(`Updating chart for ${currentInstrument} with timeframe ${currentTimeframe}`);
        }

        // Update trading balance
        function updateTradingBalance() {
            if (currentUser) {
                $('#tradingBalance').text(`$${(currentUser.walletBalance || 0).toFixed(2)}`);
                $('#freeMargin').text(`$${(currentUser.walletBalance || 0).toFixed(2)}`);
            }
        }

        // Simulate order book data
        function simulateOrderBook() {
            const basePrice = 43250;
            
            // Generate bids (buy orders)
            let bidsHtml = '';
            for (let i = 0; i < 5; i++) {
                const price = basePrice - (i * 10);
                const size = (Math.random() * 5).toFixed(2);
                bidsHtml += `
                    <div class="bid-row d-flex justify-content-between">
                        <span class="text-success">$${price.toFixed(2)}</span>
                        <span>${size}</span>
                    </div>
                `;
            }
            $('#orderBookBids').html(bidsHtml);
            
            // Generate asks (sell orders)
            let asksHtml = '';
            for (let i = 0; i < 5; i++) {
                const price = basePrice + (i * 10);
                const size = (Math.random() * 5).toFixed(2);
                asksHtml += `
                    <div class="ask-row d-flex justify-content-between">
                        <span class="text-danger">$${price.toFixed(2)}</span>
                        <span>${size}</span>
                    </div>
                `;
            }
            $('#orderBookAsks').html(asksHtml);
            
            // Update current price
            $('#currentPrice').text('$' + basePrice.toFixed(2));
        }

        // Start price updates
        function startPriceUpdates() {
            setInterval(() => {
                updateCurrentPrices();
            }, 3000);
        }

        // Update current prices
        function updateCurrentPrices() {
            const instruments = $('.instrument-item');
            instruments.each(function() {
                const symbol = $(this).data('symbol');
                const currentPrice = parseFloat($(this).find('.fw-bold.text-light').text().replace('$', '').replace(',', ''));
                const change = (Math.random() - 0.5) * 2; // -1% to +1% change
                const newPrice = currentPrice * (1 + change / 100);
                
                $(this).find('.fw-bold.text-light').text('$' + newPrice.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 5
                }));
                
                const changeElement = $(this).find('small');
                changeElement.text((change >= 0 ? '+' : '') + change.toFixed(2) + '%');
                changeElement.removeClass('price-up price-down')
                           .addClass(change >= 0 ? 'price-up' : 'price-down');
                
                if (symbol === currentInstrument) {
                    $('#currentPrice').text('$' + newPrice.toLocaleString(undefined, {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 5
                    }));
                }
            });
        }

        // Place trading order
        function placeOrder(type) {
            if (tradingSettings.confirmOrders && !confirm(`Are you sure you want to place a ${type.toUpperCase()} order?`)) {
                return;
            }
            
            const symbol = $('#tradeSymbol').val();
            const volume = parseFloat($('#tradeVolume').val());
            const leverage = parseInt($('#tradeLeverage').val());
            const takeProfit = $('#takeProfit').val();
            const stopLoss = $('#stopLoss').val();
            
            // Validation
            if (!volume || volume <= 0) {
                showTradingAlert('Please enter a valid volume', 'danger');
                return;
            }
            
            showLoading(true);
            
            // Simulate order processing
            setTimeout(() => {
                const order = {
                    id: Date.now(),
                    symbol: symbol,
                    type: type,
                    volume: volume,
                    leverage: leverage,
                    takeProfit: takeProfit,
                    stopLoss: stopLoss,
                    status: 'open',
                    openTime: new Date().toISOString(),
                    openPrice: parseFloat($('#currentPrice').text().replace('$', ''))
                };
                
                openPositions.push(order);
                updatePositions();
                
                showTradingAlert(
                    `${type.toUpperCase()} order executed: ${volume} lots ${symbol}`,
                    'success'
                );
                
                showLoading(false);
                
                // Play sound if enabled
                if (tradingSettings.soundAlerts) {
                    // In a real app, play a sound
                }
                
            }, 1000);
        }

        // Update positions display
        function updatePositions() {
            if (openPositions.length === 0) {
                $('#openPositions').html(`
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-box-open fa-2x mb-2"></i>
                        <p>No open positions</p>
                        <small>Open a trade to see your positions here</small>
                    </div>
                `);
                return;
            }
            
            let html = '';
            openPositions.forEach(position => {
                const currentPrice = parseFloat($('#currentPrice').text().replace('$', ''));
                const pl = position.type === 'buy' ? 
                    (currentPrice - position.openPrice) * position.volume * 100000 : 
                    (position.openPrice - currentPrice) * position.volume * 100000;
                
                const plClass = pl >= 0 ? 'text-success' : 'text-danger';
                const plIcon = pl >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                
                html += `
                    <div class="position-item ${position.type === 'sell' ? 'sell' : ''}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="fw-bold">${position.symbol}</div>
                                <small class="text-muted">
                                    ${position.type.toUpperCase()}  ${position.volume} lots  ${position.leverage}x
                                </small>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        Open: $${position.openPrice.toFixed(2)} | 
                                        Current: $${currentPrice.toFixed(2)}
                                    </small>
                                </div>
                                ${position.stopLoss ? `<small class="text-danger">SL: $${position.stopLoss}</small>` : ''}
                                ${position.takeProfit ? `<small class="text-success">TP: $${position.takeProfit}</small>` : ''}
                            </div>
                            <div class="text-end">
                                <div class="fw-bold ${plClass}">
                                    <i class="fas ${plIcon} me-1"></i>
                                    $${pl.toFixed(2)}
                                </div>
                                <button class="btn btn-sm btn-outline-light mt-1" onclick="closePosition(${position.id})">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            $('#openPositions').html(html);
        }

        // Close position
        function closePosition(positionId) {
            const positionIndex = openPositions.findIndex(p => p.id === positionId);
            if (positionIndex === -1) return;
            
            openPositions.splice(positionIndex, 1);
            updatePositions();
            
            showTradingAlert('Position closed successfully', 'info');
        }

        // Show trading alert
        function showTradingAlert(message, type) {
            const alert = $('#tradingAlert');
            alert.removeClass('alert-success alert-danger alert-warning alert-info')
                 .addClass(`alert-${type}`)
                 .html(`<div class="d-flex justify-content-between align-items-center"><span>${message}</span><button type="button" class="btn-close" onclick="$(this).closest('.trading-alert').hide()"></button></div>`)
                 .fadeIn();
            
            setTimeout(() => {
                alert.fadeOut();
            }, 5000);
        }

        // Show loading spinner
        function showLoading(show) {
            if (show) {
                $('#loadingSpinner').show();
            } else {
                $('#loadingSpinner').hide();
            }
        }

        // Show trading settings modal
        function showTradingSettings() {
            $('#maxRisk').val(tradingSettings.maxRisk);
            $('#maxRiskValue').text(tradingSettings.maxRisk + '%');
            $('#dailyLossLimit').val(tradingSettings.dailyLossLimit);
            $('#soundAlerts').prop('checked', tradingSettings.soundAlerts);
            $('#confirmOrders').prop('checked', tradingSettings.confirmOrders);
            $('#oneClickTrading').prop('checked', tradingSettings.oneClickTrading);
            
            $('#tradingSettingsModal').modal('show');
        }

        // Save trading settings
        function saveTradingSettings() {
            tradingSettings.maxRisk = parseInt($('#maxRisk').val());
            tradingSettings.dailyLossLimit = parseFloat($('#dailyLossLimit').val());
            tradingSettings.soundAlerts = $('#soundAlerts').is(':checked');
            tradingSettings.confirmOrders = $('#confirmOrders').is(':checked');
            tradingSettings.oneClickTrading = $('#oneClickTrading').is(':checked');
            
            $('#tradingSettingsModal').modal('hide');
            showToast('Trading settings saved successfully', 'success');
        }

        // Update max risk value display
        $('#maxRisk').on('input', function() {
            $('#maxRiskValue').text($(this).val() + '%');
        });

        // Auto-calculate take profit and stop loss
        function autoCalculateLevels() {
            const currentPrice = parseFloat($('#currentPrice').text().replace('$', ''));
            const takeProfit = currentPrice * 1.02; // 2% profit
            const stopLoss = currentPrice * 0.98;   // 2% loss
            
            $('#takeProfit').val(takeProfit.toFixed(2));
            $('#stopLoss').val(stopLoss.toFixed(2));
        }

        // Calculate risk percentage
        function calculateRisk() {
            const volume = parseFloat($('#tradeVolume').val()) || 0.01;
            const leverage = parseInt($('#tradeLeverage').val()) || 1;
            const currentPrice = parseFloat($('#currentPrice').text().replace('$', ''));
            const contractSize = 100000; // Standard lot size
            
            const marginRequired = (volume * contractSize * currentPrice) / leverage;
            const balance = currentUser ? currentUser.walletBalance : 10000;
            const riskPercentage = (marginRequired / balance) * 100;
            
            $('#riskLevel').css('width', Math.min(riskPercentage, 100) + '%');
            $('#riskPercentage').text(riskPercentage.toFixed(1) + '% of balance at risk');
        }

        // Show deposit modal
        function showDepositModal() {
            $('#depositModal').modal('show');
        }

        // Submit deposit
        async function submitDeposit() {
            const formData = new FormData($('#depositForm')[0]);
            const amount = formData.get('amount');
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid deposit amount', 'danger');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE_URL}/deposits`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    $('#depositModal').modal('hide');
                    showToast(`Deposit request for $${amount} submitted successfully`, 'success');
                    $('#depositForm')[0].reset();
                    
                    // Reload user data to update balances
                    loadUserData();
                } else {
                    throw new Error(result.message || 'Deposit submission failed');
                }
            } catch (error) {
                console.error('Deposit error:', error);
                showToast(error.message || 'Deposit submission failed', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Show investment modal
        function showInvestmentModal() {
            if (currentUser) {
                $('#availableDeposit').text((currentUser.depositBalance || 0).toFixed(2));
            }
            $('#investmentModal').modal('show');
        }

        // Select investment plan
        function selectPlan(planId) {
            $('.investment-plan').removeClass('selected');
            $(`.investment-plan[data-plan="${planId}"]`).addClass('selected');
            
            selectedPlan = planId;
            
            const plans = {
                1: { name: 'Basic Plan', rate: 5 },
                2: { name: 'Premium Plan', rate: 8 },
                3: { name: 'VIP Plan', rate: 12 }
            };
            
            $('#selectedPlanName').val(plans[planId].name);
            $('#selectedPlanId').val(planId);
            $('#profitRate').text(plans[planId].rate);
            
            calculateExpectedProfit();
            $('#investButton').prop('disabled', false);
        }

        // Calculate expected profit
        function calculateExpectedProfit() {
            if (!selectedPlan) return;
            
            const amount = parseFloat($('#investmentAmount').val()) || 0;
            const plans = {
                1: { rate: 5 },
                2: { rate: 8 },
                3: { rate: 12 }
            };
            
            const profit = (amount * plans[selectedPlan].rate) / 100;
            $('#expectedProfit').text(profit.toFixed(2));
        }

        // Submit investment
        async function submitInvestment() {
            const amount = parseFloat($('#investmentAmount').val());
            const planId = $('#selectedPlanId').val();
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid investment amount', 'danger');
                return;
            }
            
            if (!planId) {
                showToast('Please select an investment plan', 'danger');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE_URL}/investments`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        planId: planId,
                        amount: amount
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    $('#investmentModal').modal('hide');
                    showToast(`Investment of $${amount} submitted successfully`, 'success');
                    
                    // Reset form
                    $('#investmentForm')[0].reset();
                    $('.investment-plan').removeClass('selected');
                    $('#investButton').prop('disabled', true);
                    
                    // Reload user data and investments
                    loadUserData();
                    loadDashboardData();
                } else {
                    throw new Error(result.message || 'Investment submission failed');
                }
            } catch (error) {
                console.error('Investment error:', error);
                showToast(error.message || 'Investment submission failed', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Show profile modal
        function showProfileModal() {
            $('#profileModal').modal('show');
        }

        // Update profile
        async function updateProfile() {
            const name = $('#profileName').val();
            const bitcoinAccount = $('#profileBitcoin').val();
            const tetherAccount = $('#profileTether').val();
            const secretQuestion = $('#profileQuestion').val();
            const secretAnswer = $('#profileAnswer').val();
            
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        bitcoinAccount: bitcoinAccount,
                        tetherTRC20Account: tetherAccount,
                        secretQuestion: secretQuestion,
                        secretAnswer: secretAnswer
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    $('#profileModal').modal('hide');
                    showToast('Profile updated successfully', 'success');
                    
                    // Update UI
                    $('#userName').text(name);
                    $('#userAvatar').text(name.substring(0, 2).toUpperCase());
                    currentUser.name = name;
                } else {
                    throw new Error(result.message || 'Profile update failed');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showToast(error.message || 'Profile update failed', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Show referrals modal
        async function showReferralsModal() {
            try {
                const response = await fetch(`${API_BASE_URL}/user/referrals`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        $('#totalReferrals').text(result.data.totalReferrals);
                        displayReferrals(result.data.referrals);
                    }
                }
            } catch (error) {
                console.error('Error loading referrals:', error);
            }
            
            $('#referralsModal').modal('show');
        }

        // Display referrals
        function displayReferrals(referrals) {
            if (!referrals || !Array.isArray(referrals)) {
                $('#referralsList').html('<tr><td colspan="4" class="text-center text-muted">No referrals yet</td></tr>');
                return;
            }
            
            let html = '';
            referrals.forEach(ref => {
                html += `
                    <tr>
                        <td>${ref.username}</td>
                        <td>${ref.email}</td>
                        <td>${new Date(ref.createdAt).toLocaleDateString()}</td>
                        <td>$${(ref.totalInvested || 0).toFixed(2)}</td>
                    </tr>
                `;
            });
            
            $('#referralsList').html(html);
        }

        // Copy referral code
        function copyReferralCode() {
            const code = $('#referralCode').val();
            navigator.clipboard.writeText(code).then(() => {
                showToast('Referral code copied to clipboard', 'success');
            });
        }

        // Copy referral link
        function copyReferralLink() {
            const link = $('#referralLink').val();
            navigator.clipboard.writeText(link).then(() => {
                showToast('Referral link copied to clipboard', 'success');
            });
        }

        // Show toast notification
        function showToast(message, type) {
            const toast = $(`
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `);
            
            $('#toastContainer').append(toast);
            const bsToast = new bootstrap.Toast(toast[0]);
            bsToast.show();
            
            // Remove toast after it's hidden
            toast.on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        // Simulate market data updates
        function simulateMarketData() {
            // This would receive real market data in a production environment
            updateCurrentPrices();
            simulateOrderBook();
        }

        // Trading tools functions (placeholder implementations)
        function addIndicator(indicator) {
            showToast(`${indicator} indicator added to chart`, 'info');
        }

        function activateTool(tool) {
            showToast(`${tool.charAt(0).toUpperCase() + tool.slice(1)} tool activated`, 'info');
        }

        function clearDrawings() {
            showToast('All drawings cleared from chart', 'info');
        }

        // Load transactions section
        async function loadTransactionsSection() {
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/transactions`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        displayTransactionsSection(result.data);
                    }
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                showToast('Failed to load transactions', 'danger');
            } finally {
                showLoading(false);
            }
        }

        function displayTransactionsSection(transactions) {
            if (!transactions || !Array.isArray(transactions)) {
                $('#otherSections').html(`
                    <div class="container-fluid py-4">
                        <div class="row">
                            <div class="col-12">
                                <div class="table-card">
                                    <div class="card-header bg-transparent">
                                        <h5 class="mb-0">Transaction History</h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted text-center">No transactions found</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                return;
            }
            
            let html = `
                <div class="container-fluid py-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="table-card">
                                <div class="card-header bg-transparent">
                                    <h5 class="mb-0">Transaction History</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Type</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                    <th>Details</th>
                                                </tr>
                                            </thead>
                                            <tbody>
            `;
            
            transactions.forEach(transaction => {
                const statusClass = transaction.status === 'approved' ? 'badge-success' : 
                                  transaction.status === 'pending' ? 'badge-warning' : 'badge-danger';
                
                html += `
                    <tr>
                        <td>${new Date(transaction.createdAt).toLocaleDateString()}</td>
                        <td>${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}</td>
                        <td>$${transaction.amount}</td>
                        <td><span class="badge ${statusClass}">${transaction.status}</span></td>
                        <td>${transaction.adminNote || transaction.investmentPlan || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('#otherSections').html(html);
            $('#otherSections').show();
            $('#dashboardSection, #tradingSection').hide();
            $('#pageTitle').text('Transaction History');
        }

        // Load section content (placeholder)
        function loadSectionContent(section) {
            $('#otherSections').html(`
                <div class="container-fluid py-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="chart-container text-center">
                                <h3>${$('#pageTitle').text()}</h3>
                                <p class="text-muted">This section is under development</p>
                                <button class="btn btn-primary mt-3" onclick="showSection('dashboard')">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        // Initialize auto-calculate on page load
        $(document).ready(function() {
            autoCalculateLevels();
            calculateRisk();
        });
    </script>
</body>
</html>